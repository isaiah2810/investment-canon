<!DOCTYPE html>
<html lang="en">
<head>
<meta name="robots" content="noindex, nofollow">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#f59e0b">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Portfolio Dashboard ‚Äî Carlin Invests</title>
<style>
  :root {
    --bg:#0a0a0f;--card-bg:#12121a;--card-border:#1e1e2e;--card-hover:#1a1a28;
    --text:#e0e0e8;--text-muted:#888899;--accent:#f59e0b;--accent-dim:#78500d;
    --green:#10b981;--red:#ef4444;--blue:#3b82f6;--purple:#a855f7;
    --gold:#f59e0b;--silver:#94a3b8;
  }
  [data-theme="light"] {
    --bg:#f8f9fa;--card-bg:#ffffff;--card-border:#e5e7eb;--card-hover:#f3f4f6;
    --text:#1f2937;--text-muted:#6b7280;--accent:#f59e0b;--accent-dim:#fbbf24;
    --green:#10b981;--red:#ef4444;--blue:#3b82f6;--purple:#a855f7;
    --gold:#f59e0b;--silver:#94a3b8;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,'Inter',sans-serif;background:var(--bg);color:var(--text);padding:20px;min-height:100vh}
  .header{text-align:center;margin-bottom:24px;margin-top:24px}
  .header h1{font-size:26px;font-weight:700} .header h1 span{color:var(--accent)}
  .header .sub{color:var(--text-muted);font-size:12px;margin-top:4px}
  .header .updated{color:var(--text-muted);font-size:11px;margin-top:2px}

  /* Hero stats */
  .hero{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-bottom:20px}
  .hero-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:10px;padding:16px;text-align:center}
  .hero-card .val{font-size:24px;font-weight:800;line-height:1.2}
  .hero-card .lbl{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-top:4px}
  .positive{color:var(--green)}.negative{color:var(--red)}

  /* Tabs */
  .tabs{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;justify-content:center}
  .tab{background:rgba(255,255,255,0.06);border:1px solid var(--card-border);color:var(--text-muted);padding:6px 16px;border-radius:20px;cursor:pointer;font-size:12px;font-weight:500;transition:all .2s}
  .tab:hover{border-color:var(--accent);color:var(--text)}
  .tab.active{background:var(--accent);color:#000;border-color:var(--accent);font-weight:600}

  /* Person summary cards */
  .people-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-bottom:20px}
  .person-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:10px;padding:14px;transition:border-color .2s;cursor:pointer}
  .person-card:hover{border-color:var(--accent-dim)}
  .person-card.active{border-color:var(--accent)}
  .person-card .name{font-size:14px;font-weight:700;margin-bottom:2px}
  .person-card .accounts{font-size:10px;color:var(--text-muted);margin-bottom:8px}
  .person-card .row{display:flex;justify-content:space-between;font-size:12px;margin-bottom:2px}
  .person-card .row .label{color:var(--text-muted)}

  /* Position table */
  .table-wrap{overflow-x:auto;margin-bottom:20px}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th{text-align:left;padding:8px 10px;font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--text-muted);border-bottom:1px solid var(--card-border);white-space:nowrap}
  td{padding:10px;border-bottom:1px solid rgba(30,30,46,0.5);white-space:nowrap}
  tr:hover{background:var(--card-hover)}
  .ticker-cell{font-weight:700;cursor:pointer;color:var(--text);transition:color .2s}
  .ticker-cell:hover{color:var(--accent)}
  .stat-box{background:var(--card-bg);border:1px solid var(--card-border);border-radius:10px;padding:12px;text-align:center}
  .stat-val{font-size:22px;font-weight:700;color:var(--text)}
  .stat-label{font-size:10px;color:var(--text-muted);margin-top:2px;text-transform:uppercase;letter-spacing:0.5px}
  th.sortable{cursor:pointer;user-select:none;transition:color .2s}
  th.sortable:hover{color:var(--accent)}
  th.sortable.asc::after{content:' ‚ñ≤';font-size:8px;color:var(--accent)}
  th.sortable.desc::after{content:' ‚ñº';font-size:8px;color:var(--accent)}
  .acct-badge{font-size:9px;padding:1px 6px;border-radius:8px;background:rgba(255,255,255,0.06);color:var(--text-muted);margin-left:4px}
  .daily-pos{color:var(--green)}.daily-neg{color:var(--red)}.daily-flat{color:var(--text-muted)}
  .pnl-pos{color:var(--green);font-weight:600}.pnl-neg{color:var(--red);font-weight:600}

  /* Aggregate section */
  .section-title{font-size:16px;font-weight:700;margin:24px 0 12px;padding-bottom:6px;border-bottom:1px solid var(--card-border)}
  .section-title span{color:var(--accent)}

  /* PnL chart placeholder */
  .chart-area{background:var(--card-bg);border:1px solid var(--card-border);border-radius:10px;padding:20px;margin-bottom:20px;min-height:200px}
  .chart-area canvas{width:100%!important;height:200px!important}

  .footer{text-align:center;color:var(--text-muted);font-size:10px;margin-top:32px;padding-top:12px;border-top:1px solid var(--card-border)}

  /* Refresh button */
  .refresh-btn{background:var(--accent);border:1px solid var(--accent);color:#000;padding:10px 24px;border-radius:24px;cursor:pointer;font-size:13px;font-weight:700;transition:all .2s;display:inline-flex;align-items:center;gap:6px;margin-top:12px;box-shadow:0 2px 8px rgba(245,158,11,0.3)}
  .refresh-btn:hover{background:rgba(245,158,11,0.9);transform:translateY(-1px);box-shadow:0 4px 12px rgba(245,158,11,0.4)}
  .refresh-btn:active{transform:scale(0.97)}
  .refresh-btn.loading{opacity:0.7;pointer-events:none}
  .refresh-btn .spinner{display:none;width:14px;height:14px;border:2px solid rgba(0,0,0,0.3);border-top-color:#000;border-radius:50%;animation:spin .8s linear infinite}
  .refresh-btn.loading .spinner{display:inline-block}
  .refresh-btn.loading .refresh-icon{display:none}
  @keyframes spin{to{transform:rotate(360deg)}}
  .refresh-status{font-size:11px;color:var(--text-muted);margin-top:6px;min-height:16px;font-weight:500}
  
  /* Download button */
  .download-btn{background:rgba(59,130,246,0.2);border:1px solid var(--blue);color:var(--blue);padding:10px 24px;border-radius:24px;cursor:pointer;font-size:13px;font-weight:700;transition:all .2s;display:inline-flex;align-items:center;gap:6px;margin-top:12px;margin-left:8px}
  .download-btn:hover{background:rgba(59,130,246,0.3);transform:translateY(-1px)}
  .download-btn:active{transform:scale(0.97)}

  /* Staleness banner */
  .stale-banner{background:rgba(245,158,11,0.15);border:1px solid var(--accent-dim);border-radius:10px;padding:10px 16px;margin-bottom:16px;text-align:center;font-size:12px;color:var(--accent);display:none}
  .stale-banner.visible{display:block}
  .stale-banner .dismiss{cursor:pointer;margin-left:8px;opacity:0.6}
  .stale-banner .dismiss:hover{opacity:1}

  /* Auto-refresh indicator */
  .auto-refresh-info{font-size:10px;color:var(--text-muted);margin-top:4px}

  /* Position detail modal */
  .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center}
  .modal-overlay.visible{display:flex}
  .modal-content{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:24px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;position:relative}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid var(--card-border)}
  .modal-header h2{font-size:20px;font-weight:700}
  .modal-header .close{cursor:pointer;font-size:24px;color:var(--text-muted);transition:color .2s}
  .modal-header .close:hover{color:var(--text)}
  .modal-row{display:flex;justify-content:space-between;padding:8px 0;font-size:13px;border-bottom:1px solid rgba(30,30,46,0.3)}
  .modal-row .label{color:var(--text-muted);font-weight:500}
  .modal-row .value{font-weight:600}
  .modal-section{margin-top:20px}
  .modal-section-title{font-size:14px;font-weight:700;margin-bottom:10px;color:var(--accent)}

  /* ‚îÄ‚îÄ OTF Risk Engine Sections ‚îÄ‚îÄ */
  .risk-section{margin-top:24px}
  .risk-section-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:10px;cursor:pointer;transition:all .2s;user-select:none}
  .risk-section-header:hover{border-color:var(--accent-dim)}
  .risk-section-header h2{font-size:16px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px}
  .risk-section-header h2 span{color:var(--accent)}
  .risk-section-header .chevron{font-size:14px;color:var(--text-muted);transition:transform .2s}
  .risk-section-header.open .chevron{transform:rotate(180deg)}
  .risk-section-body{display:none;margin-top:8px;padding:16px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:10px;overflow-x:auto}
  .risk-section-body.open{display:block}

  /* Volatility table */
  .vol-table{width:100%;border-collapse:collapse;font-size:11px}
  .vol-table th{text-align:center;padding:6px 8px;font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);border-bottom:1px solid var(--card-border);white-space:nowrap}
  .vol-table th:first-child{text-align:left}
  .vol-table td{padding:6px 8px;text-align:center;border-bottom:1px solid rgba(30,30,46,0.3);white-space:nowrap}
  .vol-table td:first-child{text-align:left;font-weight:600}
  .vol-table tr:hover{background:var(--card-hover)}

  /* Status flags */
  .flag-normal{color:var(--green)}.flag-elevated{color:#eab308}.flag-critical{color:var(--red)}
  .flag-pill{font-size:9px;padding:2px 8px;border-radius:10px;font-weight:600}
  .flag-pill.green{background:rgba(16,185,129,0.15);color:var(--green)}
  .flag-pill.yellow{background:rgba(234,179,8,0.15);color:#eab308}
  .flag-pill.orange{background:rgba(249,115,22,0.15);color:#f97316}
  .flag-pill.red{background:rgba(239,68,68,0.15);color:var(--red)}

  /* Correlation heatmap */
  .corr-cell{width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;font-size:9px;font-weight:600;border-radius:4px;color:#fff}
  .corr-grid{display:grid;gap:2px;overflow-x:auto}
  .corr-label{font-size:9px;font-weight:600;color:var(--text-muted);text-align:center;display:flex;align-items:center;justify-content:center}

  /* Risk heatmap grid */
  .risk-grid{display:grid;grid-template-columns:auto repeat(24,1fr);gap:2px;font-size:9px;overflow-x:auto}
  .risk-grid .ticker-label{font-weight:700;padding:4px 8px;display:flex;align-items:center;white-space:nowrap}
  .risk-cell{width:28px;height:28px;border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .15s}
  .risk-cell:hover{transform:scale(1.2);z-index:1}
  .risk-cell.low{background:rgba(16,185,129,0.2);color:var(--green)}
  .risk-cell.medium{background:rgba(234,179,8,0.2);color:#eab308}
  .risk-cell.high{background:rgba(249,115,22,0.25);color:#f97316}
  .risk-cell.critical{background:rgba(239,68,68,0.25);color:var(--red)}

  /* Stress test */
  .stress-controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
  .stress-btn{background:rgba(255,255,255,0.06);border:1px solid var(--card-border);color:var(--text);padding:6px 14px;border-radius:16px;cursor:pointer;font-size:11px;transition:all .2s}
  .stress-btn:hover{border-color:var(--accent);color:var(--accent)}
  .stress-btn.active{background:var(--accent);color:#000;border-color:var(--accent);font-weight:600}
  .stress-result{background:rgba(0,0,0,0.3);border-radius:8px;padding:16px;margin-top:12px}
  .stress-impact{font-size:28px;font-weight:800}
  .recovery-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-top:12px}
  .recovery-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;padding:10px;text-align:center}
  .recovery-card .rate{font-size:14px;font-weight:700;color:var(--accent)}
  .recovery-card .time{font-size:20px;font-weight:800;margin-top:4px}
  .recovery-card .label{font-size:9px;color:var(--text-muted);margin-top:2px}

  /* Custom stress input */
  .stress-custom{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .stress-custom select,.stress-custom input{background:var(--card-bg);border:1px solid var(--card-border);color:var(--text);padding:6px 10px;border-radius:8px;font-size:12px}
  .stress-custom input{width:80px}

  /* Technical board */
  .tech-table{width:100%;border-collapse:collapse;font-size:12px}
  .tech-table th{text-align:left;padding:8px 10px;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);border-bottom:1px solid var(--card-border);white-space:nowrap}
  .tech-table td{padding:8px 10px;border-bottom:1px solid rgba(30,30,46,0.3)}
  .tech-table tr:hover{background:var(--card-hover)}

  @media(max-width:600px){body{padding:12px}.hero{grid-template-columns:repeat(2,1fr)}.modal-content{width:95%;padding:16px}}
  @media(max-width:768px){
    #analytics div[style*="grid-template-columns: 1fr 1fr"],
    #analytics div[style*="grid-template-columns:1fr 1fr"]{grid-template-columns:1fr !important}
    .stat-box{padding:8px}
    .stat-val{font-size:18px}
  }
  .site-nav{display:flex;justify-content:center;gap:6px;padding:12px 20px;background:var(--bg);border-bottom:1px solid var(--card-border);position:sticky;top:0;z-index:100}
  .site-nav a{color:var(--text-muted);text-decoration:none;font-size:12px;font-weight:500;padding:6px 16px;border-radius:20px;border:1px solid var(--card-border);transition:all .2s}
  .site-nav a:hover{color:var(--text);border-color:var(--accent)}
  .site-nav a.active{background:var(--accent);color:#000;border-color:var(--accent);font-weight:600}
  .site-nav .brand{color:var(--accent);font-weight:700;font-size:13px;margin-right:8px;align-self:center}
  .theme-toggle{cursor:pointer;font-size:20px;padding:4px 12px;border-radius:20px;border:1px solid var(--card-border);background:transparent;transition:all .2s;margin-left:auto}
  .theme-toggle:hover{border-color:var(--accent)}
  .lock-btn{cursor:pointer;font-size:18px;padding:4px 12px;border-radius:20px;border:1px solid var(--card-border);background:transparent;transition:all .2s;margin-left:6px}
  .lock-btn:hover{border-color:var(--red);color:var(--red)}

  /* Auth modal */
  .auth-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
  .auth-modal{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:32px;max-width:400px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.5);text-align:center}
  .auth-modal h2{font-size:22px;margin-bottom:8px;color:var(--text)}
  .auth-modal p{color:var(--text-muted);font-size:13px;margin-bottom:24px;line-height:1.5}
  .auth-modal input{width:100%;padding:14px;font-size:18px;text-align:center;border:2px solid var(--card-border);border-radius:10px;background:var(--bg);color:var(--text);margin-bottom:16px;letter-spacing:4px;font-weight:600;transition:border-color .2s}
  .auth-modal input:focus{outline:none;border-color:var(--accent)}
  .auth-modal .error{color:var(--red);font-size:12px;margin-bottom:12px;min-height:18px}
  .auth-submit{background:var(--accent);border:none;color:#000;padding:12px 32px;border-radius:24px;cursor:pointer;font-size:14px;font-weight:700;width:100%;transition:all .2s}
  .auth-submit:hover{background:rgba(245,158,11,0.9);transform:translateY(-1px)}
  .auth-submit:active{transform:scale(0.97)}
  .auth-modal .lock-icon{font-size:48px;margin-bottom:16px}
</style>
</head>
<body>

<!-- Auth overlay (shown until authenticated) -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-modal">
    <div class="lock-icon">üîí</div>
    <h2>Portfolio Access</h2>
    <p>This dashboard contains private family financial data.<br>Please enter your PIN to continue.</p>
    <input type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" id="authPinInput" autocomplete="off">
    <div class="error" id="authError"></div>
    <button class="auth-submit" onclick="checkAuth()">Unlock</button>
  </div>
</div>

<nav class="site-nav"><span class="brand">Carlin Invests</span><a href="index.html">üìö Canon</a><a href="investor-database.html">üèÜ Investors</a><a href="portfolio.html" class="active">üìä Portfolio</a><button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button><button class="lock-btn" onclick="logout()" title="Lock Dashboard">üîê</button></nav>

<div class="header">
  <h1>üìä <span>Portfolio</span> Dashboard</h1>
  <div class="sub">Family Investment Tracker ‚Äî Real-Time P&L</div>
  <div class="updated" id="lastUpdated"></div>
  <button class="refresh-btn" id="refreshBtn" onclick="refreshPrices()">
    <span class="refresh-icon">üîÑ</span>
    <span class="spinner"></span>
    Refresh Prices
  </button>
  <button class="download-btn" onclick="exportToCSV()">
    üì• Export CSV
  </button>
  <div class="refresh-status" id="refreshStatus"></div>
  <div class="auto-refresh-info" id="autoRefreshInfo"></div>
</div>

<div class="stale-banner" id="staleBanner">
  ‚ö†Ô∏è <span id="staleText">Data may be outdated</span>
  <span class="dismiss" onclick="document.getElementById('staleBanner').classList.remove('visible')">‚úï</span>
</div>

<div class="hero" id="hero"></div>

<div class="section-title">üë§ <span>By Person</span></div>
<div class="people-row" id="people-row"></div>

<div class="section-title">üìà <span>History</span></div>
<div class="benchmark-controls" style="display:flex;gap:12px;justify-content:center;margin-bottom:12px;flex-wrap:wrap">
  <div style="background:rgba(255,255,255,0.06);border-radius:16px;padding:2px;display:flex">
    <button id="modePnl" onclick="setChartMode('pnl')" style="background:var(--accent);color:#000;border:none;border-radius:14px;padding:4px 12px;font-size:11px;font-weight:700;cursor:pointer">P&L %</button>
    <button id="modeValue" onclick="setChartMode('value')" style="background:transparent;color:var(--text-muted);border:none;border-radius:14px;padding:4px 12px;font-size:11px;font-weight:500;cursor:pointer">Value ¬£</button>
  </div>
  <div style="width:1px;background:var(--card-border);margin:0 4px"></div>
  <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;color:var(--text-muted)">
    <input type="checkbox" id="benchSP500" onchange="renderChart()" style="cursor:pointer"> 
    <span>üìä S&P 500</span>
  </label>
  <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;color:var(--text-muted)">
    <input type="checkbox" id="benchFTSE" onchange="renderChart()" style="cursor:pointer">
    <span>üá¨üáß FTSE 100</span>
  </label>
  <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;color:var(--text-muted)">
    <input type="checkbox" id="benchGold" onchange="renderChart()" style="cursor:pointer">
    <span>‚ú® Gold</span>
  </label>
</div>
<div class="chart-area"><canvas id="pnlChart"></canvas></div>

<div class="tabs" id="view-tabs">
  <button class="tab active" data-view="accounts">By Account</button>
  <button class="tab" data-view="people">By Person</button>
  <button class="tab" data-view="aggregate">Aggregate</button>
</div>

<div class="tabs" id="acct-tabs"></div>

<div class="table-wrap"><table id="positions-table"><thead id="table-head"></thead><tbody id="table-body"></tbody></table></div>

<div id="analytics"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- OTF RISK ENGINE SECTIONS                                              -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- 1. Volatility Dashboard -->
<div class="risk-section" id="volatility-section">
  <div class="risk-section-header" onclick="toggleSection('volatility')">
    <h2>üìä <span>Volatility</span> Dashboard</h2>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="risk-section-body" id="volatility-body">
    <div id="volatility-content"><p style="color:var(--text-muted);font-size:12px">Loading volatility data...</p></div>
  </div>
</div>

<!-- 2. Liquidity Monitor -->
<div class="risk-section" id="liquidity-section">
  <div class="risk-section-header" onclick="toggleSection('liquidity')">
    <h2>üíß <span>Liquidity</span> Monitor</h2>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="risk-section-body" id="liquidity-body">
    <div id="liquidity-content"><p style="color:var(--text-muted);font-size:12px">Loading liquidity data...</p></div>
  </div>
</div>

<!-- 3. Correlation Matrix -->
<div class="risk-section" id="correlation-section">
  <div class="risk-section-header" onclick="toggleSection('correlation')">
    <h2>üîó <span>Correlation</span> Matrix</h2>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="risk-section-body" id="correlation-body">
    <div id="correlation-content"><p style="color:var(--text-muted);font-size:12px">Loading correlation data...</p></div>
  </div>
</div>

<!-- 4. Technical Tracking Board -->
<div class="risk-section" id="technical-section">
  <div class="risk-section-header" onclick="toggleSection('technical')">
    <h2>üìê <span>Technical</span> Tracking Board</h2>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="risk-section-body" id="technical-body">
    <div id="technical-content"><p style="color:var(--text-muted);font-size:12px">Loading technical data...</p></div>
  </div>
</div>

<!-- 5. Risk Heatmap -->
<div class="risk-section" id="riskheatmap-section">
  <div class="risk-section-header" onclick="toggleSection('riskheatmap')">
    <h2>üî• <span>Risk</span> Heatmap</h2>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="risk-section-body" id="riskheatmap-body">
    <div id="riskheatmap-content"><p style="color:var(--text-muted);font-size:12px">Loading risk data...</p></div>
  </div>
</div>

<!-- 6. Stress Test Simulator -->
<div class="risk-section" id="stresstest-section">
  <div class="risk-section-header" onclick="toggleSection('stresstest')">
    <h2>‚ö° <span>Stress Test</span> Simulator</h2>
    <span class="chevron">‚ñº</span>
  </div>
  <div class="risk-section-body" id="stresstest-body">
    <div id="stresstest-content"><p style="color:var(--text-muted);font-size:12px">Loading stress test...</p></div>
  </div>
</div>

<div class="footer">Portfolio Dashboard v2 ‚Ä¢ Carlin Invests ‚Ä¢ OTF Risk Engine ‚Ä¢ Auto-updated at market close</div>

<!-- Position Detail Modal -->
<div class="modal-overlay" id="positionModal" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 id="modalTicker">-</h2>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
// ====== VARIABLES ======
let activeView = "accounts";
let activeFilter = "all"; // "all" or account/person name
let chart = null;
let chartMode = 'pnl'; // 'pnl' or 'value'
let BENCHMARK_DATA = null; // Cached benchmark historical data
let sortCol = "valueGbp";
let sortDir = "desc";

function setChartMode(mode) {
  chartMode = mode;
  // Update UI
  const btnPnl = document.getElementById('modePnl');
  const btnVal = document.getElementById('modeValue');
  
  if (mode === 'pnl') {
    btnPnl.style.background = 'var(--accent)';
    btnPnl.style.color = '#000';
    btnPnl.style.fontWeight = '700';
    btnVal.style.background = 'transparent';
    btnVal.style.color = 'var(--text-muted)';
    btnVal.style.fontWeight = '500';
  } else {
    btnVal.style.background = 'var(--accent)';
    btnVal.style.color = '#000';
    btnVal.style.fontWeight = '700';
    btnPnl.style.background = 'transparent';
    btnPnl.style.color = 'var(--text-muted)';
    btnPnl.style.fontWeight = '500';
  }
  renderChart();
}

// ====== THEME ======
function initTheme() {
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);
  updateThemeIcon(savedTheme);
}

function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  updateThemeIcon(newTheme);
  
  // Re-render chart with new colors
  if (chart) renderChart();
}

function updateThemeIcon(theme) {
  const toggle = document.getElementById('themeToggle');
  if (toggle) {
    toggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  }
}

// Initialize theme before page load
initTheme();

// ====== AUTHENTICATION ======
const AUTH_HASH = '76ced5b53829bb4ca8ab376be09683e92512ef0aab8fb68fcee5121596f94143'; // SHA-256 of PIN

async function sha256(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function checkAuth() {
  const input = document.getElementById('authPinInput');
  const error = document.getElementById('authError');
  const pin = input.value.trim();
  
  if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
    error.textContent = 'Please enter a 4-digit PIN';
    input.value = '';
    input.focus();
    return;
  }
  
  const hash = await sha256(pin);
  
  if (hash === AUTH_HASH) {
    // Correct PIN
    sessionStorage.setItem('portfolio_auth', 'true');
    document.getElementById('authOverlay').style.display = 'none';
    error.textContent = '';
    input.value = '';
    // Load data after authentication
    loadData();
  } else {
    // Wrong PIN
    error.textContent = 'Incorrect PIN. Please try again.';
    input.value = '';
    input.focus();
  }
}

function logout() {
  if (confirm('Lock dashboard? You will need to re-enter PIN.')) {
    sessionStorage.removeItem('portfolio_auth');
    location.reload();
  }
}

function checkAuthStatus() {
  const isAuth = sessionStorage.getItem('portfolio_auth') === 'true';
  const overlay = document.getElementById('authOverlay');
  
  if (isAuth) {
    overlay.style.display = 'none';
    loadData(); // Load data if already authenticated
  } else {
    overlay.style.display = 'flex';
    // Focus PIN input
    setTimeout(() => {
      document.getElementById('authPinInput').focus();
    }, 100);
    // Add Enter key listener
    document.getElementById('authPinInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') checkAuth();
    });
  }
}

// Check auth on page load
// checkAuthStatus(); // Moved down to avoid TDZ

// Data will be injected by the build script or loaded from JSON
let DATA = null;
let FULL_HISTORY_LOADED = false;
const LATEST_URL = "data/portfolio_latest.json?t=" + Date.now();
const HISTORY_URL = "data/portfolio_history.json?t=" + Date.now();

// Check auth on page load
checkAuthStatus();

async function loadData() {
  // Load latest snapshot first (small, fast)
  try {
    const r = await fetch(LATEST_URL);
    DATA = await r.json();
    render();
    onDataLoaded();
  } catch(e) {
    // Fallback to full history if latest doesn't exist (backward compatibility)
    try {
      const r = await fetch(HISTORY_URL);
      DATA = await r.json();
      FULL_HISTORY_LOADED = true;
      render();
      onDataLoaded();
    } catch(e2) {
      // Try embedded data
      if(window.PORTFOLIO_DATA) { DATA = window.PORTFOLIO_DATA; render(); onDataLoaded(); }
      else { 
      document.getElementById("hero").innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--red)">
        <h3>‚ùå Data Load Error</h3>
        <p>${e.message}</p>
        <p style="font-size:10px;color:var(--text-muted);margin-top:8px">Try checking the console for details or hard refreshing.</p>
      </div>`;
      console.error("Data load failed:", e);
    }
    }
  }
}

async function loadFullHistory() {
  // Lazy-load full history for chart rendering (only called when needed)
  if (FULL_HISTORY_LOADED) return;
  
  try {
    const r = await fetch(HISTORY_URL);
    const fullData = await r.json();
    DATA.snapshots = fullData.snapshots; // Replace snapshots with full history
    FULL_HISTORY_LOADED = true;
  } catch(e) {
    console.warn('Failed to load full history:', e);
  }
}

function onDataLoaded() {
  checkStaleness();
  // Auto-refresh prices on page load
  refreshPrices().then(() => {
    document.getElementById('staleBanner').classList.remove('visible');
  }).catch(e => console.warn('Auto-refresh failed:', e));
  startAutoRefresh();
}



function latest() { return DATA.snapshots[DATA.snapshots.length - 1]; }
function prev() { return DATA.snapshots.length > 1 ? DATA.snapshots[DATA.snapshots.length - 2] : null; }

function fmt(n) { return '¬£' + n.toLocaleString('en-GB', {minimumFractionDigits:2, maximumFractionDigits:2}); }
function fmtPct(n) { return (n >= 0 ? '+' : '') + n.toFixed(2) + '%'; }
function pnlClass(n) { return n > 0 ? 'positive' : n < 0 ? 'negative' : ''; }
function dailyClass(n) { return n > 0 ? 'daily-pos' : n < 0 ? 'daily-neg' : 'daily-flat'; }

function renderHero() {
  const s = latest();
  const ft = s.family_total;
  const totalAccounts = Object.keys(s.accounts).length;
  const totalPositions = Object.values(s.accounts).reduce((sum, a) => sum + a.positions.length, 0);
  
  document.getElementById("lastUpdated").textContent = `Last updated: ${s.date} at ${s.timestamp.split('T')[1].substring(0,5)}`;
  
  document.getElementById("hero").innerHTML = `
    <div class="hero-card"><div class="val">${fmt(ft.total_gbp)}</div><div class="lbl">Family Total</div></div>
    <div class="hero-card"><div class="val">${fmt(ft.investments_gbp)}</div><div class="lbl">Investments</div></div>
    <div class="hero-card"><div class="val">${fmt(ft.cash_gbp)}</div><div class="lbl">Cash</div></div>
    <div class="hero-card"><div class="val ${pnlClass(ft.pnl_gbp)}">${fmt(ft.pnl_gbp)}</div><div class="lbl">Total P&L</div></div>
    <div class="hero-card"><div class="val ${pnlClass(ft.pnl_pct)}">${fmtPct(ft.pnl_pct)}</div><div class="lbl">P&L %</div></div>
    <div class="hero-card"><div class="val" style="color:var(--accent)">${totalPositions}</div><div class="lbl">Positions</div></div>
  `;
}

function renderPeople() {
  const s = latest();
  const people = s.people || {};
  let html = '';
  
  // Add "All" card
  const ft = s.family_total;
  html += `<div class="person-card ${activeFilter==='all'?'active':''}" data-person="all">
    <div class="name">üë®‚Äçüë©‚Äçüëß Family</div>
    <div class="accounts">${Object.keys(s.accounts).length} accounts</div>
    <div class="row"><span class="label">Total</span><span>${fmt(ft.total_gbp)}</span></div>
    <div class="row"><span class="label">P&L</span><span class="${pnlClass(ft.pnl_pct)}">${fmtPct(ft.pnl_pct)}</span></div>
  </div>`;
  
  for (const [name, data] of Object.entries(people)) {
    const emoji = name === 'Carlin' ? 'üë§' : name === 'Nana' ? 'üëß' : 'üë©';
    html += `<div class="person-card ${activeFilter===name?'active':''}" data-person="${name}">
      <div class="name">${emoji} ${name}</div>
      <div class="accounts">${data.accounts.join(' + ')}</div>
      <div class="row"><span class="label">Investments</span><span>${fmt(data.investments_gbp)}</span></div>
      <div class="row"><span class="label">Cash</span><span>${fmt(data.cash_gbp)}</span></div>
      <div class="row"><span class="label">Total</span><span>${fmt(data.total_gbp)}</span></div>
      <div class="row"><span class="label">P&L</span><span class="${pnlClass(data.pnl_pct)}">${fmtPct(data.pnl_pct)}</span></div>
    </div>`;
  }
  
  document.getElementById("people-row").innerHTML = html;
  
  // Click handlers
  document.querySelectorAll(".person-card").forEach(card => {
    card.addEventListener("click", () => {
      activeFilter = card.dataset.person;
      renderPeople();
      renderAcctTabs();
      renderTable();
    });
  });
}

function renderAcctTabs() {
  const s = latest();
  let html = '';
  
  if (activeView === 'accounts') {
    const accounts = activeFilter === 'all' 
      ? Object.keys(s.accounts) 
      : (s.people[activeFilter]?.accounts || Object.keys(s.accounts));
    
    html += `<button class="tab active" data-acct="all">All Accounts</button>`;
    accounts.forEach(a => {
      html += `<button class="tab" data-acct="${a}">${a}</button>`;
    });
  }
  
  document.getElementById("acct-tabs").innerHTML = html;
  document.querySelectorAll("#acct-tabs .tab").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll("#acct-tabs .tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      renderTable();
    });
  });
}

function renderTable() {
  const s = latest();
  const activeAcct = document.querySelector("#acct-tabs .tab.active")?.dataset.acct || "all";
  
  let positions = [];
  
  if (activeView === 'aggregate') {
    // Show aggregate positions
    for (const [ticker, data] of Object.entries(s.aggregate)) {
      positions.push({
        ticker,
        name: data.name,
        exchange: data.exchange,
        currency: data.currency,
        units: data.total_units,
        avgPrice: data.weighted_avg_price,
        currentPrice: data.current_price,
        dailyChange: data.daily_change_pct,
        valueGbp: data.value_gbp,
        costGbp: data.total_cost_gbp,
        pnlGbp: data.pnl_gbp,
        pnlPct: data.pnl_pct,
        accounts: data.accounts.map(a => a.account).join(', ')
      });
    }
  } else if (activeView === 'people') {
    // Show person-level aggregated positions
    const people = activeFilter === 'all' ? Object.keys(s.people) : [activeFilter];
    for (const person of people) {
      const pdata = s.people[person];
      if (!pdata) continue;
      for (const [ticker, data] of Object.entries(pdata.positions)) {
        positions.push({
          ticker,
          name: data.name,
          exchange: data.exchange,
          currency: data.currency,
          units: data.total_units,
          avgPrice: data.weighted_avg_price,
          currentPrice: data.current_price,
          dailyChange: data.daily_change_pct,
          valueGbp: data.value_gbp,
          costGbp: data.total_cost_gbp,
          pnlGbp: data.pnl_gbp,
          pnlPct: data.pnl_pct,
          accounts: person
        });
      }
    }
  } else {
    // Account view
    let accountsToShow;
    if (activeFilter === 'all') {
      accountsToShow = activeAcct === 'all' ? Object.keys(s.accounts) : [activeAcct];
    } else {
      const personAccounts = s.people[activeFilter]?.accounts || [];
      accountsToShow = activeAcct === 'all' ? personAccounts : [activeAcct];
    }
    
    for (const acctName of accountsToShow) {
      const acct = s.accounts[acctName];
      if (!acct) continue;
      for (const pos of acct.positions) {
        positions.push({
          ticker: pos.ticker,
          name: pos.name,
          exchange: pos.exchange,
          currency: pos.currency,
          units: pos.units,
          avgPrice: pos.avg_price,
          currentPrice: pos.current_price,
          dailyChange: pos.daily_change_pct,
          valueGbp: pos.value_gbp,
          costGbp: pos.book_cost_gbp,
          pnlGbp: pos.pnl_gbp,
          pnlPct: pos.pnl_pct,
          accounts: acctName
        });
      }
    }
  }
  
  // Sort
  const dir = sortDir === 'asc' ? 1 : -1;
  positions.sort((a, b) => {
    let va = a[sortCol], vb = b[sortCol];
    if (typeof va === 'string') return dir * va.localeCompare(vb);
    return dir * ((va||0) - (vb||0));
  });
  
  // Render
  const showAcctCol = activeView !== 'accounts' || activeAcct === 'all';
  const cols = [
    {key:'ticker', label:'Ticker', sortable:true},
    ...(showAcctCol ? [{key:'accounts', label:'Account', sortable:true}] : []),
    {key:'currentPrice', label:'Price', sortable:true},
    {key:'dailyChange', label:'Daily', sortable:true},
    {key:'units', label:'Units', sortable:true},
    {key:'avgPrice', label:'Avg Cost', sortable:false},
    {key:'valueGbp', label:'Value (¬£)', sortable:true},
    {key:'pnlGbp', label:'P&L (¬£)', sortable:true},
    {key:'pnlPct', label:'P&L %', sortable:true},
  ];
  
  const headHtml = cols.map(c => {
    if (!c.sortable) return `<th>${c.label}</th>`;
    const cls = sortCol === c.key ? (sortDir === 'asc' ? 'sortable asc' : 'sortable desc') : 'sortable';
    return `<th class="${cls}" data-sort="${c.key}">${c.label}</th>`;
  }).join('');
  document.getElementById("table-head").innerHTML = `<tr>${headHtml}</tr>`;
  
  // Attach sort handlers
  document.querySelectorAll("th.sortable").forEach(th => {
    th.addEventListener("click", () => {
      const col = th.dataset.sort;
      if (sortCol === col) { sortDir = sortDir === 'desc' ? 'asc' : 'desc'; }
      else { sortCol = col; sortDir = col === 'ticker' || col === 'accounts' ? 'asc' : 'desc'; }
      renderTable();
    });
  });
  
  let totalVal = 0, totalPnl = 0, totalCost = 0;
  let bodyHtml = '';
  
  positions.forEach(p => {
    totalVal += p.valueGbp;
    totalPnl += p.pnlGbp;
    totalCost += p.costGbp;
    
    const priceStr = p.currency === 'GBP' ? `¬£${p.currentPrice.toFixed(2)}` :
                     p.currency === 'CAD' ? `C$${p.currentPrice.toFixed(3)}` :
                     p.currency === 'AUD' ? `A$${p.currentPrice.toFixed(3)}` :
                     `$${p.currentPrice.toFixed(2)}`;
    const avgStr = p.currency === 'GBP' ? `¬£${p.avgPrice.toFixed(2)}` :
                   p.currency === 'CAD' ? `C$${p.avgPrice.toFixed(3)}` :
                   p.currency === 'AUD' ? `A$${p.avgPrice.toFixed(3)}` :
                   `$${p.avgPrice.toFixed(2)}`;
    const unitsStr = p.units >= 1000 ? p.units.toLocaleString('en-GB', {maximumFractionDigits:0}) : p.units.toLocaleString('en-GB', {maximumFractionDigits:2});
    
    bodyHtml += `<tr>
      <td class="ticker-cell" onclick="showPositionModal('${p.ticker}')">${p.ticker} <span style="font-size:9px;color:var(--text-muted)">${p.exchange}</span></td>
      ${showAcctCol ? `<td><span class="acct-badge">${p.accounts}</span></td>` : ''}
      <td>${priceStr}</td>
      <td class="${dailyClass(p.dailyChange)}">${fmtPct(p.dailyChange)}</td>
      <td>${unitsStr}</td>
      <td style="color:var(--text-muted)">${avgStr}</td>
      <td>${fmt(p.valueGbp)}</td>
      <td class="${p.pnlGbp>=0?'pnl-pos':'pnl-neg'}">${fmt(p.pnlGbp)}</td>
      <td class="${p.pnlPct>=0?'pnl-pos':'pnl-neg'}">${fmtPct(p.pnlPct)}</td>
    </tr>`;
  });
  
  // Footer row
  const totalPnlPct = totalCost > 0 ? (totalPnl / totalCost * 100) : 0;
  bodyHtml += `<tr style="border-top:2px solid var(--card-border);font-weight:700">
    <td>TOTAL</td>
    ${showAcctCol ? '<td></td>' : ''}
    <td></td><td></td><td></td><td></td>
    <td>${fmt(totalVal)}</td>
    <td class="${totalPnl>=0?'pnl-pos':'pnl-neg'}">${fmt(totalPnl)}</td>
    <td class="${totalPnlPct>=0?'pnl-pos':'pnl-neg'}">${fmtPct(totalPnlPct)}</td>
  </tr>`;
  
  document.getElementById("table-body").innerHTML = bodyHtml;
}

// Sector/industry classification
const SECTORS = {
  ETM:['Energy Transition Metals','Lithium'], HSLV:['Precious Metals','Silver'],
  QIMC:['Precious Metals','Gold/Silver'], GSPR:['Precious Metals','Gold'],
  TI:['Precious Metals','Gold/Silver'], CTGO:['Precious Metals','Gold/Silver'],
  MGG:['Precious Metals','Gold'], NAU:['Precious Metals','Gold'],
  OSS:['Technology','Defense/AI'], ALTA:['Precious Metals','Gold'],
  HSTR:['Precious Metals','Gold/Silver'], FF:['Precious Metals','Gold'],
  LG:['Base Metals','Copper/Gold'], GDXJ:['Precious Metals','Gold ETF'],
  GDX:['Precious Metals','Gold ETF'], CDE:['Precious Metals','Gold/Silver'],
  SSLN:['Precious Metals','Silver ETF'], SBRY:['Consumer Staples','Grocery'],
  GRG:['Industrials','Building Materials'], GDGB:['Precious Metals','Gold ETF'],
  MASS:['Precious Metals','Silver'], TRT:['Precious Metals','Gold/Silver']
};

function renderAnalytics() {
  if (!DATA) return;
  const s = DATA.snapshots[DATA.snapshots.length - 1];
  
  // Build aggregate positions
  const allPositions = [];
  for (const [acctName, acct] of Object.entries(s.accounts)) {
    for (const p of acct.positions) {
      allPositions.push({...p, account: acctName});
    }
  }
  
  // Aggregate by ticker
  const byTicker = {};
  allPositions.forEach(p => {
    if (!byTicker[p.ticker]) byTicker[p.ticker] = {ticker:p.ticker, value:0, cost:0, pnl:0};
    byTicker[p.ticker].value += p.value_gbp;
    byTicker[p.ticker].cost += p.book_cost_gbp;
    byTicker[p.ticker].pnl += p.pnl_gbp;
  });
  
  const totalInv = s.family_total.investments_gbp;
  const totalCash = s.family_total.cash_gbp;
  const totalVal = s.family_total.total_gbp;
  
  // --- Stats ---
  const uniqueTickers = Object.keys(byTicker).length;
  const uniqueExchanges = new Set(allPositions.map(p => p.exchange)).size;
  const uniqueCurrencies = new Set(allPositions.map(p => p.currency)).size;
  const winners = Object.values(byTicker).filter(p => p.pnl >= 0).length;
  const losers = Object.values(byTicker).filter(p => p.pnl < 0).length;
  const cashPct = (totalCash / totalVal * 100).toFixed(1);
  
  // Top/bottom performers
  const sorted = Object.values(byTicker).sort((a,b) => b.pnl - a.pnl);
  const top3 = sorted.slice(0, 3);
  const bottom3 = sorted.slice(-3).reverse();
  
  // Concentration: top 5 by value
  const byValue = Object.values(byTicker).sort((a,b) => b.value - a.value);
  const top5Value = byValue.slice(0, 5);
  const top5Pct = (top5Value.reduce((s,p) => s + p.value, 0) / totalInv * 100).toFixed(1);
  const largestPct = (byValue[0].value / totalInv * 100).toFixed(1);
  
  // Sector breakdown
  const sectorVal = {};
  const sectorPnl = {};
  for (const [ticker, data] of Object.entries(byTicker)) {
    const sec = (SECTORS[ticker] || ['Other'])[0];
    sectorVal[sec] = (sectorVal[sec] || 0) + data.value;
    sectorPnl[sec] = (sectorPnl[sec] || 0) + data.pnl;
  }
  
  // Sub-industry breakdown
  const subVal = {};
  for (const [ticker, data] of Object.entries(byTicker)) {
    const sub = (SECTORS[ticker] || ['Other','Other'])[1];
    subVal[sub] = (subVal[sub] || 0) + data.value;
  }
  
  // Exchange breakdown
  const exchVal = {};
  allPositions.forEach(p => {
    exchVal[p.exchange] = (exchVal[p.exchange] || 0) + p.value_gbp;
  });
  
  // Currency exposure
  const ccyVal = {};
  allPositions.forEach(p => {
    ccyVal[p.currency] = (ccyVal[p.currency] || 0) + p.value_gbp;
  });
  
  // Render bar helper
  const bar = (label, value, total, color, pnl) => {
    const pct = (value / total * 100);
    const pnlStr = pnl !== undefined ? ` <span class="${pnl>=0?'pnl-pos':'pnl-neg'}" style="font-size:11px">(${pnl>=0?'+':''}¬£${Math.abs(pnl).toLocaleString('en-GB',{maximumFractionDigits:0})})</span>` : '';
    return `<div style="margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;margin-bottom:3px">
        <span style="font-size:12px;font-weight:500">${label}${pnlStr}</span>
        <span style="font-size:12px;color:var(--text-muted)">${pct.toFixed(1)}% ¬∑ ¬£${value.toLocaleString('en-GB',{maximumFractionDigits:0})}</span>
      </div>
      <div style="height:6px;background:var(--card-bg);border-radius:3px;overflow:hidden">
        <div style="height:100%;width:${Math.min(pct,100)}%;background:${color};border-radius:3px"></div>
      </div>
    </div>`;
  };
  
  const sectorColors = {'Precious Metals':'#f59e0b','Energy Transition Metals':'#3b82f6','Base Metals':'#10b981','Technology':'#a855f7','Consumer Staples':'#ef4444','Industrials':'#6b7280','Other':'#444'};
  const subColors = {'Gold':'#f59e0b','Silver':'#c0c0c0','Gold/Silver':'#d4a437','Gold ETF':'#b8860b','Silver ETF':'#a8a8a8','Lithium':'#3b82f6','Copper/Gold':'#10b981','Defense/AI':'#a855f7','Grocery':'#ef4444','Building Materials':'#6b7280','Other':'#444'};
  
  let html = `<div class="section-title" style="margin-top:32px">üìà Portfolio Analytics</div>`;
  
  // Key metrics row
  html += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px">
    <div class="stat-box"><div class="stat-val">${uniqueTickers}</div><div class="stat-label">Companies</div></div>
    <div class="stat-box"><div class="stat-val" style="color:var(--green)">${winners}</div><div class="stat-label">Winners</div></div>
    <div class="stat-box"><div class="stat-val" style="color:var(--red)">${losers}</div><div class="stat-label">Losers</div></div>
    <div class="stat-box"><div class="stat-val">${cashPct}%</div><div class="stat-label">Cash Weight</div></div>
    <div class="stat-box"><div class="stat-val">${largestPct}%</div><div class="stat-label">Largest Position</div></div>
    <div class="stat-box"><div class="stat-val">${top5Pct}%</div><div class="stat-label">Top 5 Concentration</div></div>
    <div class="stat-box"><div class="stat-val">${uniqueExchanges}</div><div class="stat-label">Exchanges</div></div>
    <div class="stat-box"><div class="stat-val">${uniqueCurrencies}</div><div class="stat-label">Currencies</div></div>
  </div>`;
  
  // Two-column layout
  html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">`;
  
  // Left: Sector breakdown
  html += `<div class="card" style="padding:16px"><h3 style="font-size:14px;margin-bottom:12px;color:var(--accent)">üè≠ Sector Allocation</h3>`;
  Object.entries(sectorVal).sort((a,b) => b[1] - a[1]).forEach(([sec, val]) => {
    html += bar(sec, val, totalInv, sectorColors[sec]||'#888', sectorPnl[sec]);
  });
  html += `</div>`;
  
  // Right: Sub-industry
  html += `<div class="card" style="padding:16px"><h3 style="font-size:14px;margin-bottom:12px;color:var(--accent)">‚õèÔ∏è Sub-Industry Breakdown</h3>`;
  Object.entries(subVal).sort((a,b) => b[1] - a[1]).forEach(([sub, val]) => {
    html += bar(sub, val, totalInv, subColors[sub]||'#888');
  });
  html += `</div>`;
  
  // Exchange + Currency row
  html += `</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:16px">`;
  
  // Left: Exchange
  html += `<div class="card" style="padding:16px"><h3 style="font-size:14px;margin-bottom:12px;color:var(--accent)">üåç Exchange Distribution</h3>`;
  const exchColors = {TSXV:'#f59e0b',ASX:'#3b82f6',TSX:'#10b981',LSE:'#a855f7',NYSE:'#ef4444',NYSEAMERICAN:'#ff6b6b',CSE:'#6b7280',NASDAQ:'#06b6d4'};
  Object.entries(exchVal).sort((a,b) => b[1] - a[1]).forEach(([exch, val]) => {
    html += bar(exch, val, totalInv, exchColors[exch]||'#888');
  });
  html += `</div>`;
  
  // Right: Currency
  html += `<div class="card" style="padding:16px"><h3 style="font-size:14px;margin-bottom:12px;color:var(--accent)">üí± Currency Exposure</h3>`;
  const ccyColors = {CAD:'#ef4444',AUD:'#3b82f6',USD:'#10b981',GBP:'#f59e0b'};
  Object.entries(ccyVal).sort((a,b) => b[1] - a[1]).forEach(([ccy, val]) => {
    html += bar(ccy, val, totalInv, ccyColors[ccy]||'#888');
  });
  html += `</div></div>`;
  
  // Top/Bottom performers
  html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:16px">`;
  
  html += `<div class="card" style="padding:16px"><h3 style="font-size:14px;margin-bottom:12px;color:var(--green)">üèÜ Top Performers (¬£)</h3>`;
  top3.forEach(p => {
    const pct = p.cost > 0 ? (p.pnl/p.cost*100) : 0;
    html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--card-border)">
      <span style="font-weight:600">${p.ticker}</span>
      <span class="pnl-pos">+¬£${p.pnl.toLocaleString('en-GB',{maximumFractionDigits:0})} (${pct>=0?'+':''}${pct.toFixed(1)}%)</span>
    </div>`;
  });
  html += `</div>`;
  
  html += `<div class="card" style="padding:16px"><h3 style="font-size:14px;margin-bottom:12px;color:var(--red)">üìâ Worst Performers (¬£)</h3>`;
  bottom3.forEach(p => {
    const pct = p.cost > 0 ? (p.pnl/p.cost*100) : 0;
    html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--card-border)">
      <span style="font-weight:600">${p.ticker}</span>
      <span class="pnl-neg">-¬£${Math.abs(p.pnl).toLocaleString('en-GB',{maximumFractionDigits:0})} (${pct.toFixed(1)}%)</span>
    </div>`;
  });
  html += `</div></div>`;
  
  // Position size distribution
  html += `<div class="card" style="padding:16px;margin-top:16px"><h3 style="font-size:14px;margin-bottom:12px;color:var(--accent)">üìä Position Size Distribution</h3>`;
  html += `<div style="display:flex;gap:4px;align-items:flex-end;height:120px">`;
  byValue.forEach(p => {
    const pct = (p.value / totalInv * 100);
    const height = Math.max(4, pct * 2.5);
    const col = p.pnl >= 0 ? 'var(--green)' : 'var(--red)';
    html += `<div title="${p.ticker}: ¬£${p.value.toLocaleString('en-GB',{maximumFractionDigits:0})} (${pct.toFixed(1)}%)" style="flex:1;height:${height}px;background:${col};border-radius:3px 3px 0 0;min-width:12px;cursor:pointer;opacity:0.8;transition:opacity .2s" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.8"></div>`;
  });
  html += `</div><div style="display:flex;gap:4px;margin-top:4px">`;
  byValue.forEach(p => {
    html += `<div style="flex:1;text-align:center;font-size:8px;color:var(--text-muted);min-width:12px;overflow:hidden">${p.ticker}</div>`;
  });
  html += `</div></div>`;
  
  document.getElementById("analytics").innerHTML = html;
}

async function renderChart() {
  if (!DATA || DATA.snapshots.length < 1) return;
  
  // Lazy-load full history if not already loaded
  if (typeof loadFullHistory === 'function') await loadFullHistory();
  
  const labels = DATA.snapshots.map(s => s.date);
  
  // Data selection based on mode
  const isValue = chartMode === 'value';
  const familyData = DATA.snapshots.map(s => isValue ? s.family_total.total_gbp : s.family_total.pnl_pct);
  
  // Person-level series
  const people = Object.keys(DATA.snapshots[DATA.snapshots.length-1].people || {});
  const personSeries = {};
  people.forEach(p => {
    personSeries[p] = DATA.snapshots.map(s => {
      const pData = s.people?.[p];
      if (!pData) return null;
      return isValue ? pData.total_gbp : pData.pnl_pct;
    });
  });
  
  const colors = {Family:'#f59e0b', Carlin:'#3b82f6', Nana:'#10b981', Dada:'#a855f7'};
  
  const datasets = [
    {
      label: 'Family', 
      data: familyData, 
      borderColor: colors.Family, 
      backgroundColor: colors.Family+'20', 
      tension: 0.3, 
      borderWidth: 2, 
      fill: true
    }
  ];
  
  people.forEach(p => {
    datasets.push({
      label: p, 
      data: personSeries[p], 
      borderColor: colors[p]||'#888', 
      tension: 0.3, 
      borderWidth: 1.5, 
      borderDash: [4,2], 
      fill: false, 
      pointRadius: 2
    });
  });
  
  // Add benchmarks (ONLY IN P&L MODE)
  const includeSP500 = document.getElementById('benchSP500')?.checked;
  const includeFTSE = document.getElementById('benchFTSE')?.checked;
  const includeGold = document.getElementById('benchGold')?.checked;

  if (!isValue && (includeSP500 || includeFTSE || includeGold)) {
    if (!BENCHMARK_DATA) await fetchBenchmarkData();

    if (BENCHMARK_DATA) {
      const portfolioDates = DATA.snapshots.map(s => s.date);
      
      if (includeSP500 && BENCHMARK_DATA['^GSPC']) {
        datasets.push({
          label: 'üìä S&P 500',
          data: alignBenchmarkData(BENCHMARK_DATA['^GSPC'], portfolioDates),
          borderColor: '#6b7280',
          tension: 0.3, borderWidth: 1.5, borderDash: [6, 4], pointRadius: 0
        });
      }
      if (includeFTSE && BENCHMARK_DATA['^FTSE']) {
        datasets.push({
          label: 'üá¨üáß FTSE 100',
          data: alignBenchmarkData(BENCHMARK_DATA['^FTSE'], portfolioDates),
          borderColor: '#8b5cf6',
          tension: 0.3, borderWidth: 1.5, borderDash: [2, 3], pointRadius: 0
        });
      }
      if (includeGold && BENCHMARK_DATA['GC=F']) {
        datasets.push({
          label: '‚ú® Gold',
          data: alignBenchmarkData(BENCHMARK_DATA['GC=F'], portfolioDates),
          borderColor: '#fbbf24',
          tension: 0.3, borderWidth: 1.5, borderDash: [8, 2], pointRadius: 0
        });
      }
    }
  }
  
  const ctx = document.getElementById('pnlChart').getContext('2d');
  if (chart) chart.destroy();
  
  const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim();
  const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--card-border').trim();
  
  chart = new Chart(ctx, {
    type: 'line',
    data: {labels, datasets},
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {labels:{color:textColor,font:{size:11}}},
        tooltip: {
          callbacks: {
            label: ctx => {
              const label = ctx.dataset.label;
              const val = ctx.parsed.y;
              if (isValue) return `${label}: ¬£${val.toLocaleString('en-GB', {maximumFractionDigits:0})}`;
              return `${label}: ${val >= 0 ? '+' : ''}${val.toFixed(2)}%`;
            }
          }
        }
      },
      scales: {
        x: {ticks:{color:textColor,font:{size:10}},grid:{color:gridColor}},
        y: {
          ticks:{
            color:textColor,
            font:{size:10},
            callback: v => isValue ? '¬£' + (v/1000).toFixed(0) + 'k' : v + '%'
          },
          grid:{color:gridColor},
          title:{display:true, text: isValue ? 'Portfolio Value' : 'P&L %', color:textColor}
        }
      }
    }
  });
}

// Fetch benchmark historical data
async function fetchBenchmarkData() {
  if (!DATA || DATA.snapshots.length < 2) return null;
  if (BENCHMARK_DATA) return BENCHMARK_DATA; // Return cached

  const dates = DATA.snapshots.map(s => s.date);
  const startDate = dates[0];
  const endDate = dates[dates.length - 1];
  
  console.log(`Fetching benchmark data from ${startDate} to ${endDate}`);
  
  try {
    const benchmarks = {
      '^GSPC': 'S&P 500',
      '^FTSE': 'FTSE 100',
      'GC=F': 'Gold'
    };
    
    const results = {};
    
    for (const [ticker, name] of Object.entries(benchmarks)) {
      try {
        const resp = await fetch(`${PRICE_SERVER_URL}/api/history?ticker=${ticker}&start=${startDate}&end=${endDate}`);
        if (!resp.ok) {
          console.warn(`Failed to fetch ${name}: ${resp.status}`);
          continue;
        }
        const data = await resp.json();
        
        if (!data.prices || data.prices.length === 0) {
          console.warn(`No price data for ${name}`);
          continue;
        }
        
        // Calculate percentage change from first date
        const firstPrice = data.prices[0].close;
        const pctChanges = data.prices.map(p => ((p.close - firstPrice) / firstPrice) * 100);
        
        results[ticker] = {
          name,
          dates: data.prices.map(p => p.date),
          pctChanges
        };
        
        console.log(`‚úÖ ${name}: ${data.prices.length} data points, first=${firstPrice.toFixed(2)}`);
      } catch (e) {
        console.warn(`Error fetching ${name}:`, e);
      }
    }
    
    BENCHMARK_DATA = results;
    return results;
  } catch (e) {
    console.error('Benchmark fetch error:', e);
    return null;
  }
}

// Helper function to align benchmark data with portfolio dates
function alignBenchmarkData(benchmark, portfolioDates) {
  const aligned = [];
  for (const pDate of portfolioDates) {
    // Find closest benchmark date (on or after portfolio date)
    let closestIdx = -1;
    let minDiff = Infinity;
    
    for (let i = 0; i < benchmark.dates.length; i++) {
      const bDate = new Date(benchmark.dates[i]);
      const pDateObj = new Date(pDate);
      const diff = Math.abs(bDate - pDateObj);
      
      if (diff < minDiff) {
        minDiff = diff;
        closestIdx = i;
      }
    }
    
    if (closestIdx >= 0) {
      aligned.push(benchmark.pctChanges[closestIdx]);
    } else {
      aligned.push(null);
    }
  }
  return aligned;
}

function render() {
  renderHero();
  renderPeople();
  renderAcctTabs();
  renderTable();
  renderChart();
  renderAnalytics();
}

// View tab handlers
document.querySelectorAll("#view-tabs .tab").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("#view-tabs .tab").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    activeView = btn.dataset.view;
    renderAcctTabs();
    renderTable();
  });
});

// ====== LIVE REFRESH ======
// Uses local price_server.py proxy (port 8777) to bypass Yahoo Finance CORS restrictions.
// The server fetches from Yahoo Finance server-side and returns JSON with CORS headers.
// Start with: python3 ~/clawd/stock-monitor/price_server.py

// Auto-detect: if local, use same origin; if GitHub Pages, use Cloudflare tunnel to price server
const PRICE_SERVER_URL = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
  ? location.origin  // same-origin when served from price server
  : 'https://sitting-tiny-causes-forth.trycloudflare.com';

async function refreshPrices() {
  if (!DATA) return;
  
  const btn = document.getElementById('refreshBtn');
  const status = document.getElementById('refreshStatus');
  btn.classList.add('loading');
  status.textContent = 'Connecting to price server...';
  
  try {
    // 1. Fetch all prices + FX from local proxy (single call, ~2s)
    let resp;
    try {
      resp = await fetch(`${PRICE_SERVER_URL}/api/prices`);
    } catch(e) {
      status.textContent = '‚ùå Price server not running. Start with: python3 ~/clawd/stock-monitor/price_server.py';
      btn.classList.remove('loading');
      return;
    }
    
    if (!resp.ok) {
      status.textContent = `‚ùå Price server error: ${resp.status}`;
      btn.classList.remove('loading');
      return;
    }
    
    const data = await resp.json();
    const prices = data.prices;    // { ticker: { price, prev_close, daily_change_pct, currency } }
    const fxRates = data.fx_rates; // { USD: 0.74, CAD: 0.54, AUD: 0.52, GBP: 1.0 }
    
    console.log('Live prices:', prices);
    console.log('FX rates:', fxRates);
    status.textContent = `Recalculating P&L (${data.fetched} prices, ${data.elapsed_seconds}s)...`;
    
    const s = latest();
    
    // 2. Update all positions with live prices
    // IMPORTANT: book_cost_gbp is PRESERVED from snapshot ‚Äî it was calculated at purchase time
    // with the historical FX rate. Only current value changes with live prices.
    for (const [acctName, acct] of Object.entries(s.accounts)) {
      let acctTotalValue = 0;
      let acctTotalCost = 0;
      
      for (const pos of acct.positions) {
        const liveData = prices[pos.ticker];
        if (liveData) {
          pos.current_price = liveData.price;
          pos.daily_change_pct = liveData.daily_change_pct;
        }
        
        // Recalculate current VALUE in GBP using live FX rate
        const liveInfo = prices[pos.ticker];
        const ccy = (liveInfo && liveInfo.currency) ? liveInfo.currency : pos.currency;
        const fxRate = fxRates[ccy] || 1;
        pos.value_gbp = pos.units * pos.current_price * fxRate;
        
        // book_cost_gbp is PRESERVED from the snapshot ‚Äî do NOT recalculate
        // It was computed at snapshot time with the correct historical context
        pos.pnl_gbp = pos.value_gbp - pos.book_cost_gbp;
        pos.pnl_pct = pos.book_cost_gbp > 0 ? (pos.pnl_gbp / pos.book_cost_gbp * 100) : 0;
        
        acctTotalValue += pos.value_gbp;
        acctTotalCost += pos.book_cost_gbp;
      }
      
      acct.total_value_gbp = acctTotalValue;
      acct.total_cost_gbp = acctTotalCost;
      acct.pnl_gbp = acctTotalValue - acctTotalCost;
      acct.pnl_pct = acctTotalCost > 0 ? (acct.pnl_gbp / acctTotalCost * 100) : 0;
    }
    
    // 3. Recalculate people aggregates
    const peopleMap = {
      'Carlin': ['CP II', 'CP IBKR'],
      'Nana': ['NANA'],
      'Dada': ['DADA']
    };
    
    for (const [person, accounts] of Object.entries(peopleMap)) {
      if (!s.people[person]) continue;
      let invGbp = 0, costGbp = 0, cashGbp = 0;
      const positionsAgg = {};
      
      for (const acctName of accounts) {
        const acct = s.accounts[acctName];
        if (!acct) continue;
        invGbp += acct.total_value_gbp;
        costGbp += acct.total_cost_gbp;
        cashGbp += acct.cash_gbp;
        
        for (const pos of acct.positions) {
          if (!positionsAgg[pos.ticker]) {
            positionsAgg[pos.ticker] = {
              name: pos.name, exchange: pos.exchange, currency: pos.currency,
              total_units: 0, total_value_gbp: 0, total_cost_gbp: 0,
              current_price: pos.current_price, daily_change_pct: pos.daily_change_pct,
              weighted_avg_sum: 0
            };
          }
          const a = positionsAgg[pos.ticker];
          a.total_units += pos.units;
          a.total_value_gbp += pos.value_gbp;
          a.total_cost_gbp += pos.book_cost_gbp;
          a.weighted_avg_sum += pos.avg_price * pos.units;
          a.current_price = pos.current_price;
          a.daily_change_pct = pos.daily_change_pct;
        }
      }
      
      for (const [ticker, a] of Object.entries(positionsAgg)) {
        a.weighted_avg_price = a.total_units > 0 ? a.weighted_avg_sum / a.total_units : 0;
        a.value_gbp = a.total_value_gbp;
        a.pnl_gbp = a.total_value_gbp - a.total_cost_gbp;
        a.pnl_pct = a.total_cost_gbp > 0 ? (a.pnl_gbp / a.total_cost_gbp * 100) : 0;
        delete a.weighted_avg_sum;
      }
      
      s.people[person].investments_gbp = invGbp;
      s.people[person].total_gbp = invGbp + cashGbp;
      s.people[person].cash_gbp = cashGbp;
      s.people[person].pnl_gbp = invGbp - costGbp;
      s.people[person].pnl_pct = costGbp > 0 ? ((invGbp - costGbp) / costGbp * 100) : 0;
      s.people[person].positions = positionsAgg;
    }
    
    // 4. Recalculate aggregate (all accounts)
    const aggAll = {};
    for (const [acctName, acct] of Object.entries(s.accounts)) {
      for (const pos of acct.positions) {
        if (!aggAll[pos.ticker]) {
          aggAll[pos.ticker] = {
            name: pos.name, exchange: pos.exchange, currency: pos.currency,
            total_units: 0, current_price: pos.current_price, daily_change_pct: pos.daily_change_pct,
            value_gbp: 0, total_cost_gbp: 0, weighted_avg_sum: 0, accounts: []
          };
        }
        const a = aggAll[pos.ticker];
        a.total_units += pos.units;
        a.value_gbp += pos.value_gbp;
        a.total_cost_gbp += pos.book_cost_gbp;
        a.weighted_avg_sum += pos.avg_price * pos.units;
        a.current_price = pos.current_price;
        a.daily_change_pct = pos.daily_change_pct;
        a.accounts.push({ account: acctName });
      }
    }
    for (const [ticker, a] of Object.entries(aggAll)) {
      a.weighted_avg_price = a.total_units > 0 ? a.weighted_avg_sum / a.total_units : 0;
      a.pnl_gbp = a.value_gbp - a.total_cost_gbp;
      a.pnl_pct = a.total_cost_gbp > 0 ? (a.pnl_gbp / a.total_cost_gbp * 100) : 0;
      delete a.weighted_avg_sum;
    }
    s.aggregate = aggAll;
    
    // 5. Recalculate family total
    let famInv = 0, famCost = 0, famCash = 0;
    for (const acct of Object.values(s.accounts)) {
      famInv += acct.total_value_gbp;
      famCost += acct.total_cost_gbp;
      famCash += acct.cash_gbp;
    }
    s.family_total.investments_gbp = famInv;
    s.family_total.cash_gbp = famCash;
    s.family_total.total_gbp = famInv + famCash;
    s.family_total.book_cost_gbp = famCost;
    s.family_total.pnl_gbp = famInv - famCost;
    s.family_total.pnl_pct = famCost > 0 ? ((famInv - famCost) / famCost * 100) : 0;
    
    // 6. Update timestamp
    const now = new Date();
    s.date = now.toISOString().split('T')[0];
    s.timestamp = now.toISOString();
    
    // 7. Re-render everything
    render();
    
    document.getElementById('lastUpdated').textContent = `Live prices refreshed: ${now.toLocaleTimeString('en-GB', {hour:'2-digit',minute:'2-digit',second:'2-digit'})}`;

    
    const fxStr = ['USD','CAD','AUD'].map(c => `${c}=${fxRates[c] ? fxRates[c].toFixed(4) : 'N/A'}`).join(', ');
    status.textContent = `‚úÖ ${data.fetched} prices updated` + (data.failed > 0 ? ` (${data.failed} failed: ${data.failed_tickers.join(', ')})` : '') + ` ¬∑ FX: ${fxStr} ¬∑ ${data.elapsed_seconds}s`;
    
  } catch(e) {
    console.error('Refresh error:', e);
    status.textContent = `‚ùå Error: ${e.message}`;
  } finally {
    btn.classList.remove('loading');
  }
}

// ====== EXPORT TO CSV ======
function exportToCSV() {
  if (!DATA) {
    alert('No data to export');
    return;
  }
  
  const s = latest();
  const timestamp = new Date().toISOString().split('T')[0];
  let filename = `portfolio-${activeView}-${timestamp}.csv`;
  let rows = [];
  
  // Build CSV based on current view
  if (activeView === 'aggregate') {
    // Aggregate view
    rows.push(['Ticker', 'Name', 'Exchange', 'Currency', 'Units', 'Avg Price', 'Current Price', 'Daily Change %', 'Value (GBP)', 'Cost (GBP)', 'P&L (GBP)', 'P&L %', 'Accounts']);
    
    for (const [ticker, data] of Object.entries(s.aggregate)) {
      rows.push([
        ticker,
        data.name,
        data.exchange,
        data.currency,
        data.total_units.toFixed(4),
        data.weighted_avg_price.toFixed(4),
        data.current_price.toFixed(4),
        data.daily_change_pct.toFixed(2),
        data.value_gbp.toFixed(2),
        data.total_cost_gbp.toFixed(2),
        data.pnl_gbp.toFixed(2),
        data.pnl_pct.toFixed(2),
        data.accounts.map(a => a.account).join('; ')
      ]);
    }
  } else if (activeView === 'people') {
    // People view
    const activeFilter = document.querySelector("#acct-tabs .tab.active")?.dataset.acct || "all";
    const people = activeFilter === 'all' ? Object.keys(s.people) : [activeFilter];
    
    rows.push(['Person', 'Ticker', 'Name', 'Exchange', 'Currency', 'Units', 'Avg Price', 'Current Price', 'Daily Change %', 'Value (GBP)', 'Cost (GBP)', 'P&L (GBP)', 'P&L %', 'Accounts']);
    
    for (const person of people) {
      const pdata = s.people[person];
      if (!pdata) continue;
      
      for (const [ticker, data] of Object.entries(pdata.positions)) {
        rows.push([
          person,
          ticker,
          data.name,
          data.exchange,
          data.currency,
          data.total_units.toFixed(4),
          data.weighted_avg_price.toFixed(4),
          data.current_price.toFixed(4),
          data.daily_change_pct.toFixed(2),
          data.value_gbp.toFixed(2),
          data.total_cost_gbp.toFixed(2),
          data.pnl_gbp.toFixed(2),
          data.pnl_pct.toFixed(2),
          data.accounts.map(a => a.account).join('; ')
        ]);
      }
    }
  } else {
    // Account view
    const activeAcct = document.querySelector("#acct-tabs .tab.active")?.dataset.acct || "all";
    const accounts = activeAcct === 'all' ? s.accounts : s.accounts.filter(a => a.account === activeAcct);
    
    rows.push(['Account', 'Ticker', 'Name', 'Exchange', 'Currency', 'Units', 'Avg Price', 'Current Price', 'Daily Change %', 'Value (GBP)', 'Cost (GBP)', 'P&L (GBP)', 'P&L %']);
    
    for (const acct of accounts) {
      for (const pos of acct.positions) {
        rows.push([
          acct.account,
          pos.ticker,
          pos.name,
          pos.exchange,
          pos.currency,
          pos.units.toFixed(4),
          pos.avg_price.toFixed(4),
          pos.current_price.toFixed(4),
          pos.daily_change_pct.toFixed(2),
          pos.value_gbp.toFixed(2),
          pos.book_cost_gbp.toFixed(2),
          pos.pnl_gbp.toFixed(2),
          pos.pnl_pct.toFixed(2)
        ]);
      }
    }
  }
  
  // Convert to CSV string
  const csvContent = rows.map(row => 
    row.map(cell => {
      // Escape quotes and wrap in quotes if contains comma/quote/newline
      const str = String(cell);
      if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }).join(',')
  ).join('\n');
  
  // Download
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  
  // Show feedback
  const status = document.getElementById('refreshStatus');
  status.textContent = `‚úÖ Exported ${rows.length - 1} positions to ${filename}`;
  setTimeout(() => status.textContent = '', 3000);
}

// ====== POSITION DETAIL MODAL ======
function showPositionModal(ticker) {
  if (!DATA) return;
  
  const s = latest();
  let positionData = null;
  
  // Find position data based on current view
  if (activeView === 'aggregate' && s.aggregate[ticker]) {
    positionData = s.aggregate[ticker];
  } else if (activeView === 'people') {
    const activeFilter = document.querySelector("#acct-tabs .tab.active")?.dataset.acct || "all";
    const people = activeFilter === 'all' ? Object.keys(s.people) : [activeFilter];
    for (const person of people) {
      if (s.people[person]?.positions[ticker]) {
        positionData = s.people[person].positions[ticker];
        positionData.person = person;
        break;
      }
    }
  } else {
    // Account view
    const activeAcct = document.querySelector("#acct-tabs .tab.active")?.dataset.acct || "all";
    const accounts = activeAcct === 'all' ? s.accounts : s.accounts.filter(a => a.account === activeAcct);
    for (const acct of accounts) {
      const pos = acct.positions.find(p => p.ticker === ticker);
      if (pos) {
        positionData = pos;
        positionData.account = acct.account;
        break;
      }
    }
  }
  
  if (!positionData) return;
  
  // Build modal content
  document.getElementById('modalTicker').textContent = `${ticker} ‚Äî ${positionData.name}`;
  
  const priceStr = positionData.currency === 'GBP' ? `¬£${positionData.current_price.toFixed(4)}` :
                   positionData.currency === 'CAD' ? `C$${positionData.current_price.toFixed(4)}` :
                   positionData.currency === 'AUD' ? `A$${positionData.current_price.toFixed(4)}` :
                   `$${positionData.current_price.toFixed(4)}`;
  
  const avgStr = positionData.currency === 'GBP' ? `¬£${positionData.weighted_avg_price?.toFixed(4) || positionData.avg_price?.toFixed(4)}` :
                 positionData.currency === 'CAD' ? `C$${positionData.weighted_avg_price?.toFixed(4) || positionData.avg_price?.toFixed(4)}` :
                 positionData.currency === 'AUD' ? `A$${positionData.weighted_avg_price?.toFixed(4) || positionData.avg_price?.toFixed(4)}` :
                 `$${positionData.weighted_avg_price?.toFixed(4) || positionData.avg_price?.toFixed(4)}`;
  
  const units = positionData.total_units || positionData.units;
  const valueGbp = positionData.value_gbp;
  const costGbp = positionData.total_cost_gbp || positionData.book_cost_gbp;
  const pnlGbp = positionData.pnl_gbp;
  const pnlPct = positionData.pnl_pct;
  const dailyChangePct = positionData.daily_change_pct;
  
  let html = `
    <div class="modal-section">
      <div class="modal-row">
        <span class="label">Exchange</span>
        <span class="value">${positionData.exchange}</span>
      </div>
      <div class="modal-row">
        <span class="label">Currency</span>
        <span class="value">${positionData.currency}</span>
      </div>
      ${positionData.person ? `<div class="modal-row"><span class="label">Person</span><span class="value">${positionData.person}</span></div>` : ''}
      ${positionData.account ? `<div class="modal-row"><span class="label">Account</span><span class="value">${positionData.account}</span></div>` : ''}
      ${positionData.accounts ? `<div class="modal-row"><span class="label">Accounts</span><span class="value">${positionData.accounts.map(a => a.account).join(', ')}</span></div>` : ''}
    </div>
    
    <div class="modal-section">
      <div class="modal-section-title">üìä Position Details</div>
      <div class="modal-row">
        <span class="label">Units Held</span>
        <span class="value">${units.toLocaleString('en-GB', {maximumFractionDigits: 4})}</span>
      </div>
      <div class="modal-row">
        <span class="label">Current Price</span>
        <span class="value">${priceStr}</span>
      </div>
      <div class="modal-row">
        <span class="label">Average Cost</span>
        <span class="value">${avgStr}</span>
      </div>
      <div class="modal-row">
        <span class="label">Daily Change</span>
        <span class="value ${dailyChangePct >= 0 ? 'positive' : 'negative'}">${fmtPct(dailyChangePct)}</span>
      </div>
    </div>
    
    <div class="modal-section">
      <div class="modal-section-title">üí∞ P&L Summary</div>
      <div class="modal-row">
        <span class="label">Current Value</span>
        <span class="value">${fmt(valueGbp)}</span>
      </div>
      <div class="modal-row">
        <span class="label">Book Cost</span>
        <span class="value">${fmt(costGbp)}</span>
      </div>
      <div class="modal-row" style="border-bottom:none;padding-top:12px;margin-top:8px;border-top:1px solid var(--card-border)">
        <span class="label" style="font-weight:700">Profit/Loss</span>
        <span class="value ${pnlGbp >= 0 ? 'positive' : 'negative'}" style="font-size:16px">${fmt(pnlGbp)} (${fmtPct(pnlPct)})</span>
      </div>
    </div>
  `;
  
  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('positionModal').classList.add('visible');
}

function closeModal(event) {
  // Close on overlay click or explicit close button
  if (!event || event.target.id === 'positionModal') {
    document.getElementById('positionModal').classList.remove('visible');
  }
}

// ====== AUTO-REFRESH ======
let autoRefreshInterval = null;
const AUTO_REFRESH_MS = 5 * 60 * 1000; // 5 minutes

function isMarketHours() {
  const now = new Date();
  const hour = now.getUTCHours();
  const day = now.getUTCDay();
  // Skip weekends
  if (day === 0 || day === 6) return false;
  // Markets open roughly 08:00-21:00 UTC (covers LSE 08:00-16:30, NYSE 14:30-21:00, TSX 14:30-21:00)
  return hour >= 8 && hour < 21;
}

function checkStaleness() {
  if (!DATA) return;
  const s = latest();
  const snapshotTime = new Date(s.timestamp);
  const now = new Date();
  const hoursOld = (now - snapshotTime) / (1000 * 60 * 60);
  
  const banner = document.getElementById('staleBanner');
  const text = document.getElementById('staleText');
  
  if (hoursOld > 2) {
    const timeStr = hoursOld >= 24 
      ? `${Math.floor(hoursOld / 24)} day${Math.floor(hoursOld / 24) > 1 ? 's' : ''} old`
      : `${Math.floor(hoursOld)} hour${Math.floor(hoursOld) > 1 ? 's' : ''} old`;
    text.textContent = `Snapshot data is ${timeStr} ‚Äî refreshing live prices...`;
    banner.classList.add('visible');
  }
}

function startAutoRefresh() {
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  autoRefreshInterval = setInterval(() => {
    if (isMarketHours()) {
      console.log('Auto-refreshing prices (market hours)...');
      refreshPrices();
    } else {
      console.log('Auto-refresh skipped (outside market hours)');
    }
  }, AUTO_REFRESH_MS);
  
  updateAutoRefreshInfo();
}

function updateAutoRefreshInfo() {
  const el = document.getElementById('autoRefreshInfo');
  if (!el) return;
  const marketOpen = isMarketHours();
  el.textContent = marketOpen 
    ? 'üü¢ Markets open ¬∑ Auto-refreshing every 5 min'
    : 'üî¥ Markets closed ¬∑ Auto-refresh paused';
}

// Update market status every minute
setInterval(updateAutoRefreshInfo, 60000);

// ============================================================================
// OTF RISK ENGINE ‚Äî 6 New Dashboard Sections
// ============================================================================

// ‚îÄ‚îÄ Section toggle ‚îÄ‚îÄ
function toggleSection(id) {
  const header = document.querySelector(`#${id}-section .risk-section-header`);
  const body = document.getElementById(`${id}-body`);
  header.classList.toggle('open');
  body.classList.toggle('open');
}

// ‚îÄ‚îÄ Data caches ‚îÄ‚îÄ
let VOLATILITY_DATA = null;
let CORRELATION_DATA = null;
let TECHNICAL_DATA = null;
let RISK_DATA = null;

// ‚îÄ‚îÄ Load all risk engine data ‚îÄ‚îÄ
async function loadRiskEngineData() {
  const t = Date.now();
  try {
    const [volResp, corrResp, techResp, riskResp] = await Promise.allSettled([
      fetch(`data/volatility_data.json?t=${t}`),
      fetch(`data/correlation_data.json?t=${t}`),
      fetch(`data/technical_tracking.json?t=${t}`),
      fetch(`data/risk_scores.json?t=${t}`)
    ]);
    
    if (volResp.status === 'fulfilled' && volResp.value.ok) {
      VOLATILITY_DATA = await volResp.value.json();
    }
    if (corrResp.status === 'fulfilled' && corrResp.value.ok) {
      CORRELATION_DATA = await corrResp.value.json();
    }
    if (techResp.status === 'fulfilled' && techResp.value.ok) {
      TECHNICAL_DATA = await techResp.value.json();
    }
    if (riskResp.status === 'fulfilled' && riskResp.value.ok) {
      RISK_DATA = await riskResp.value.json();
    }
  } catch(e) {
    console.warn('Risk engine data load error:', e);
  }
  
  renderVolatility();
  renderLiquidity();
  renderCorrelation();
  renderTechnical();
  renderRiskHeatmap();
  renderStressTest();
}

// ‚îÄ‚îÄ 1. Volatility Dashboard ‚îÄ‚îÄ
function renderVolatility() {
  const el = document.getElementById('volatility-content');
  if (!VOLATILITY_DATA || !VOLATILITY_DATA.tickers) {
    el.innerHTML = '<p style="color:var(--text-muted);font-size:12px">No volatility data available. Run <code>python3 volatility_calc.py</code> to generate.</p>';
    return;
  }
  
  const tickers = VOLATILITY_DATA.tickers;
  const timeframes = ['1M','3M','6M','12M','3Y','5Y','10Y','Full'];
  
  // Flag helper
  function flagHtml(flag) {
    if (flag === 'trend_break') return '<span class="flag-pill red">üî¥ Trend Break</span>';
    if (flag === 'elevated') return '<span class="flag-pill yellow">üü° Elevated</span>';
    if (flag === 'normal') return '<span class="flag-pill green">üü¢ Normal</span>';
    return '<span class="flag-pill" style="background:rgba(255,255,255,0.06);color:var(--text-muted)">‚Äî</span>';
  }
  
  function sdCell(val) {
    if (val === null || val === undefined) return '<td style="color:var(--text-muted)">‚Äî</td>';
    let color = 'var(--text)';
    if (val > 80) color = 'var(--red)';
    else if (val > 50) color = '#f97316';
    else if (val > 35) color = '#eab308';
    return `<td style="color:${color};font-weight:500">${val.toFixed(1)}%</td>`;
  }
  
  let html = `<div style="margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
    <span style="font-size:11px;color:var(--text-muted)">Annualized standard deviation of daily returns ‚Ä¢ Beta vs S&P 500</span>
    <span style="font-size:10px;color:var(--text-muted)">Generated: ${new Date(VOLATILITY_DATA.generated_at).toLocaleString('en-GB')}</span>
  </div>`;
  
  // SD Table
  html += `<div style="font-size:13px;font-weight:700;margin:12px 0 6px;color:var(--accent)">üìà Standard Deviation (Annualized %)</div>`;
  html += '<table class="vol-table"><thead><tr><th style="text-align:left">Ticker</th>';
  timeframes.forEach(tf => html += `<th>${tf}</th>`);
  html += '<th>Status</th></tr></thead><tbody>';
  
  const sortedTickers = Object.entries(tickers).sort((a,b) => a[0].localeCompare(b[0]));
  for (const [ticker, data] of sortedTickers) {
    html += `<tr><td style="font-weight:700">${ticker}</td>`;
    timeframes.forEach(tf => {
      const tfData = data.timeframes?.[tf];
      html += sdCell(tfData?.sd_annualized);
    });
    html += `<td>${flagHtml(data.trend_flag)}</td></tr>`;
  }
  html += '</tbody></table>';
  
  // Beta Table
  html += `<div style="font-size:13px;font-weight:700;margin:20px 0 6px;color:var(--accent)">Œ≤ Beta vs S&P 500</div>`;
  html += '<table class="vol-table"><thead><tr><th style="text-align:left">Ticker</th>';
  timeframes.forEach(tf => html += `<th>${tf}</th>`);
  html += '</tr></thead><tbody>';
  
  for (const [ticker, data] of sortedTickers) {
    html += `<tr><td style="font-weight:700">${ticker}</td>`;
    timeframes.forEach(tf => {
      const tfData = data.timeframes?.[tf];
      const beta = tfData?.beta;
      if (beta === null || beta === undefined) {
        html += '<td style="color:var(--text-muted)">‚Äî</td>';
      } else {
        let color = 'var(--text)';
        if (Math.abs(beta) > 1.5) color = 'var(--red)';
        else if (Math.abs(beta) > 1) color = '#eab308';
        html += `<td style="color:${color};font-weight:500">${beta.toFixed(2)}</td>`;
      }
    });
    html += '</tr>';
  }
  html += '</tbody></table>';
  
  el.innerHTML = html;
}

// ‚îÄ‚îÄ 2. Liquidity Monitor ‚îÄ‚îÄ
function renderLiquidity() {
  const el = document.getElementById('liquidity-content');
  if (!VOLATILITY_DATA || !VOLATILITY_DATA.tickers) {
    el.innerHTML = '<p style="color:var(--text-muted);font-size:12px">No liquidity data available.</p>';
    return;
  }
  
  const tickers = VOLATILITY_DATA.tickers;
  
  function liqFlag(ratio) {
    if (ratio === null || ratio === undefined) return '<span class="flag-pill" style="background:rgba(255,255,255,0.06);color:var(--text-muted)">N/A</span>';
    const pct = ratio * 100;
    if (pct < 10) return `<span class="flag-pill green">üü¢ ${pct.toFixed(1)}%</span>`;
    if (pct < 50) return `<span class="flag-pill yellow">üü° ${pct.toFixed(1)}%</span>`;
    return `<span class="flag-pill red">üî¥ ${pct.toFixed(1)}%</span>`;
  }
  
  let html = `<div style="margin-bottom:12px;font-size:11px;color:var(--text-muted)">
    Position Value √∑ (30-day Avg Daily Volume √ó Price) ‚Ä¢ Lower = more liquid
  </div>`;
  
  html += '<table class="vol-table"><thead><tr><th style="text-align:left">Ticker</th><th>30d Avg Volume</th><th>Liquidity Ratio</th><th>Status</th></tr></thead><tbody>';
  
  const sortedByLiq = Object.entries(tickers).sort((a,b) => {
    const la = a[1].liquidity_ratio ?? 999;
    const lb = b[1].liquidity_ratio ?? 999;
    return lb - la; // worst first
  });
  
  for (const [ticker, data] of sortedByLiq) {
    const vol = data.avg_volume_30d;
    const volStr = vol ? (vol >= 1e6 ? (vol/1e6).toFixed(1)+'M' : vol >= 1e3 ? (vol/1e3).toFixed(0)+'K' : vol.toFixed(0)) : '‚Äî';
    const ratioStr = data.liquidity_ratio !== null ? (data.liquidity_ratio * 100).toFixed(1) + '%' : '‚Äî';
    
    html += `<tr>
      <td style="font-weight:700">${ticker} <span style="font-size:9px;color:var(--text-muted)">${data.name || ''}</span></td>
      <td>${volStr}</td>
      <td>${ratioStr}</td>
      <td>${liqFlag(data.liquidity_ratio)}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  
  el.innerHTML = html;
}

// ‚îÄ‚îÄ 3. Correlation Matrix ‚îÄ‚îÄ
function renderCorrelation() {
  const el = document.getElementById('correlation-content');
  if (!CORRELATION_DATA || !CORRELATION_DATA.matrix || !CORRELATION_DATA.tickers) {
    el.innerHTML = '<p style="color:var(--text-muted);font-size:12px">No correlation data available.</p>';
    return;
  }
  
  const tickers = CORRELATION_DATA.tickers;
  const matrix = CORRELATION_DATA.matrix;
  const n = tickers.length;
  
  function corrColor(val) {
    if (val === null || val === undefined) return 'rgba(255,255,255,0.05)';
    // Red for high positive, blue for negative, neutral for ~0
    if (val >= 0.7) return `rgba(239,68,68,${0.3 + val * 0.5})`;
    if (val >= 0.4) return `rgba(249,115,22,${0.2 + val * 0.4})`;
    if (val >= 0) return `rgba(255,255,255,${0.03 + val * 0.1})`;
    return `rgba(59,130,246,${0.2 + Math.abs(val) * 0.5})`;
  }
  
  let html = `<div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px">
    <div class="stat-box" style="flex:1;min-width:140px"><div class="stat-val" style="color:var(--accent)">${CORRELATION_DATA.diversification_score ?? '‚Äî'}</div><div class="stat-label">Diversification Score (0-100)</div></div>
    <div class="stat-box" style="flex:1;min-width:140px"><div class="stat-val">${CORRELATION_DATA.average_correlation?.toFixed(3) ?? '‚Äî'}</div><div class="stat-label">Avg Abs Correlation</div></div>
    <div class="stat-box" style="flex:1;min-width:140px"><div class="stat-val" style="color:${(CORRELATION_DATA.high_correlation_clusters?.length || 0) > 3 ? 'var(--red)' : 'var(--text)'}">${CORRELATION_DATA.high_correlation_clusters?.length ?? 0}</div><div class="stat-label">High Corr Pairs (>0.7)</div></div>
  </div>`;
  
  // High correlation alerts
  if (CORRELATION_DATA.high_correlation_clusters?.length > 0) {
    html += '<div style="margin-bottom:16px">';
    CORRELATION_DATA.high_correlation_clusters.forEach(c => {
      html += `<span class="flag-pill red" style="margin:2px 4px;display:inline-block">${c.pair[0]} ‚Üî ${c.pair[1]}: ${c.correlation.toFixed(3)}</span>`;
    });
    html += '</div>';
  }
  
  // Heatmap table
  html += `<div style="overflow-x:auto"><table class="vol-table" style="font-size:10px">
    <thead><tr><th></th>`;
  tickers.forEach(t => html += `<th style="writing-mode:vertical-lr;transform:rotate(180deg);height:60px;font-size:9px">${t}</th>`);
  html += '</tr></thead><tbody>';
  
  tickers.forEach(t1 => {
    html += `<tr><td style="font-weight:700;font-size:10px">${t1}</td>`;
    tickers.forEach(t2 => {
      const val = matrix[t1]?.[t2];
      const bg = corrColor(val);
      const text = val !== null && val !== undefined ? val.toFixed(2) : '';
      const textColor = (val !== null && (val > 0.6 || val < -0.3)) ? '#fff' : 'var(--text)';
      html += `<td style="background:${bg};color:${textColor};font-size:9px;font-weight:600;padding:4px;text-align:center" title="${t1} vs ${t2}: ${val?.toFixed(3) ?? 'N/A'}">${text}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table></div>';
  
  el.innerHTML = html;
}

// ‚îÄ‚îÄ 4. Technical Tracking Board ‚îÄ‚îÄ
function renderTechnical() {
  const el = document.getElementById('technical-content');
  if (!TECHNICAL_DATA || !TECHNICAL_DATA.positions) {
    el.innerHTML = '<p style="color:var(--text-muted);font-size:12px">No technical tracking data available.</p>';
    return;
  }
  
  const positions = TECHNICAL_DATA.positions;
  
  function statusIcon(status, currentPrice, support, resistance, target) {
    // Auto-determine status from price vs levels if set
    if (support && currentPrice && currentPrice <= support * 1.02) return 'üî¥';
    if (target && currentPrice && currentPrice >= target * 0.98) return 'üöÄ';
    if (resistance && currentPrice && currentPrice >= resistance * 0.95) return 'üü°';
    
    const map = {
      'bullish': 'üü¢', 'neutral': 'üü°', 'bearish': 'üî¥', 'target_hit': 'üöÄ',
      'at_support': 'üî¥', 'at_resistance': 'üü°'
    };
    return map[status] || '‚ö™';
  }
  
  // Get current prices from portfolio data
  const currentPrices = {};
  if (DATA) {
    const s = latest();
    for (const acct of Object.values(s.accounts)) {
      for (const pos of acct.positions) {
        currentPrices[pos.ticker] = pos.current_price;
      }
    }
  }
  
  let html = `<div style="margin-bottom:8px;font-size:11px;color:var(--text-muted)">
    Entry setups and key price levels ‚Ä¢ Edit <code>data/technical_tracking.json</code> to update
  </div>`;
  
  html += '<table class="tech-table"><thead><tr><th>Ticker</th><th>Entry Setup</th><th>Price</th><th>Support</th><th>Resistance</th><th>Target</th><th>Stop</th><th>Status</th><th>Notes</th></tr></thead><tbody>';
  
  for (const [ticker, data] of Object.entries(positions).sort((a,b) => a[0].localeCompare(b[0]))) {
    const price = currentPrices[ticker];
    const priceStr = price ? price.toFixed(3) : '‚Äî';
    const supStr = data.key_support ? data.key_support.toFixed(3) : '‚Äî';
    const resStr = data.key_resistance ? data.key_resistance.toFixed(3) : '‚Äî';
    const tgtStr = data.target ? data.target.toFixed(3) : '‚Äî';
    const stopStr = data.stop_loss ? data.stop_loss.toFixed(3) : '‚Äî';
    const icon = statusIcon(data.status, price, data.key_support, data.key_resistance, data.target);
    
    // Color price relative to support/resistance
    let priceColor = 'var(--text)';
    if (data.key_support && price && price <= data.key_support * 1.05) priceColor = 'var(--red)';
    else if (data.key_resistance && price && price >= data.key_resistance * 0.95) priceColor = 'var(--green)';
    
    html += `<tr>
      <td style="font-weight:700">${ticker}</td>
      <td style="color:${data.entry_setup === 'TBD' ? 'var(--text-muted)' : 'var(--text)'}">${data.entry_setup}</td>
      <td style="color:${priceColor};font-weight:600">${priceStr}</td>
      <td style="color:var(--red)">${supStr}</td>
      <td style="color:var(--green)">${resStr}</td>
      <td style="color:var(--accent)">${tgtStr}</td>
      <td style="color:var(--red)">${stopStr}</td>
      <td style="font-size:16px">${icon}</td>
      <td style="font-size:10px;color:var(--text-muted);max-width:150px;overflow:hidden;text-overflow:ellipsis">${data.notes || ''}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  
  el.innerHTML = html;
}

// ‚îÄ‚îÄ 5. Risk Heatmap ‚îÄ‚îÄ
function renderRiskHeatmap() {
  const el = document.getElementById('riskheatmap-content');
  if (!RISK_DATA || !RISK_DATA.positions || !RISK_DATA.categories) {
    el.innerHTML = '<p style="color:var(--text-muted);font-size:12px">No risk data available.</p>';
    return;
  }
  
  const categories = RISK_DATA.categories;
  const positions = RISK_DATA.positions;
  
  // Build flat list of all layers in order
  const allLayers = [];
  const categoryBoundaries = [];
  for (const [cat, layers] of Object.entries(categories)) {
    categoryBoundaries.push({ name: cat, start: allLayers.length, count: layers.length });
    layers.forEach(l => allLayers.push({ name: l, category: cat }));
  }
  
  function severityClass(s) { return s || 'low'; }
  function severityEmoji(s) {
    const map = { low: 'üü¢', medium: 'üü°', high: 'üü†', critical: 'üî¥' };
    return map[s] || '‚ö™';
  }
  
  let html = `<div style="margin-bottom:12px;font-size:11px;color:var(--text-muted)">
    24 risk layers across Macro (7), Company (8), Portfolio (9) ‚Ä¢ Edit <code>data/risk_scores.json</code> to update
  </div>`;
  
  // Category header row
  html += '<div style="overflow-x:auto"><table class="vol-table" style="font-size:9px"><thead>';
  html += '<tr><th></th>';
  categoryBoundaries.forEach(cb => {
    const colors = { macro: '#3b82f6', company: '#f97316', portfolio: '#a855f7' };
    html += `<th colspan="${cb.count}" style="text-align:center;color:${colors[cb.name] || 'var(--text)'};font-size:10px;font-weight:700;text-transform:uppercase;border-bottom:2px solid ${colors[cb.name] || 'var(--card-border)'}">${cb.name}</th>`;
  });
  html += '</tr>';
  
  // Layer name row
  html += '<tr><th style="font-size:10px">Ticker</th>';
  allLayers.forEach(l => {
    // Abbreviate layer names
    const short = l.name.replace('Interest Rates','IR').replace('Inflation','Infl').replace('Currency Risk','FX')
      .replace('Commodity Prices','Comm').replace('Geopolitical','Geo').replace('Regulatory/Policy','Reg')
      .replace('Market Sentiment','Sent').replace('Management Quality','Mgmt').replace('Balance Sheet','BS')
      .replace('Revenue Growth','Rev').replace('Profitability','Prof').replace('Competitive Position','Comp')
      .replace('ESG/Social License','ESG').replace('Exploration Risk','Expl').replace('Execution Risk','Exec')
      .replace('Concentration Risk','Conc').replace('Correlation Risk','Corr').replace('Liquidity Risk','Liq')
      .replace('Sector Exposure','Sect').replace('Currency Exposure','FX').replace('Valuation Risk','Val')
      .replace('Momentum','Mom').replace('Volatility Trend','Vol').replace('Technical Setup','Tech');
    html += `<th style="writing-mode:vertical-lr;transform:rotate(180deg);height:70px;font-size:8px;padding:4px 2px" title="${l.name} (${l.category})">${short}</th>`;
  });
  html += '</tr></thead><tbody>';
  
  // One row per ticker
  for (const [ticker, data] of Object.entries(positions).sort((a,b) => a[0].localeCompare(b[0]))) {
    html += `<tr><td style="font-weight:700;font-size:10px">${ticker}</td>`;
    allLayers.forEach(l => {
      const score = data.scores?.[l.name];
      const severity = score?.severity || 'low';
      const cls = severityClass(severity);
      const emoji = severityEmoji(severity);
      const title = `${ticker} ‚Äî ${l.name}: ${severity}${score?.notes ? ' ‚Ä¢ ' + score.notes : ''}`;
      html += `<td class="risk-cell ${cls}" title="${title}" style="text-align:center;padding:2px;font-size:10px;cursor:pointer">${emoji}</td>`;
    });
    html += '</tr>';
  }
  html += '</tbody></table></div>';
  
  el.innerHTML = html;
}

// ‚îÄ‚îÄ 6. Stress Test Simulator ‚îÄ‚îÄ
let stressScenario = null;

function renderStressTest() {
  const el = document.getElementById('stresstest-content');
  if (!DATA) {
    el.innerHTML = '<p style="color:var(--text-muted);font-size:12px">No portfolio data loaded.</p>';
    return;
  }
  
  const s = latest();
  const totalValue = s.family_total.total_gbp;
  
  // Pre-built scenarios
  const scenarios = [
    { name: 'Gold -30%', type: 'sector', sector: 'Precious Metals', change: -30 },
    { name: 'Gold +50%', type: 'sector', sector: 'Precious Metals', change: 50 },
    { name: 'All -20%', type: 'all', change: -20 },
    { name: 'All -50%', type: 'all', change: -50 },
    { name: 'CAD -15%', type: 'currency', currency: 'CAD', change: -15 },
    { name: 'AUD -20%', type: 'currency', currency: 'AUD', change: -20 },
    { name: 'Tech -40%', type: 'sector', sector: 'Technology', change: -40 },
    { name: 'ETM -80%', type: 'ticker', ticker: 'ETM', change: -80 },
    { name: 'Market Crash -40%', type: 'all', change: -40 },
  ];
  
  let html = `<div style="margin-bottom:12px;font-size:11px;color:var(--text-muted)">
    Select a scenario to see portfolio impact and recovery time estimates
  </div>`;
  
  // Scenario buttons
  html += '<div class="stress-controls">';
  scenarios.forEach((sc, i) => {
    const cls = stressScenario === i ? 'stress-btn active' : 'stress-btn';
    html += `<button class="${cls}" onclick="runStressTest(${i})">${sc.name}</button>`;
  });
  html += '</div>';
  
  // Custom scenario
  html += `<div class="stress-custom">
    <span style="font-size:12px;color:var(--text-muted)">Custom:</span>
    <select id="stressType" style="min-width:100px">
      <option value="all">All Positions</option>
      <option value="ticker">Single Ticker</option>
      <option value="currency">Currency</option>
    </select>
    <select id="stressTarget" style="min-width:80px;display:none"></select>
    <input id="stressChange" type="number" placeholder="-20" value="-20" style="width:70px">
    <span style="font-size:12px;color:var(--text-muted)">%</span>
    <button class="stress-btn" onclick="runCustomStress()">Run</button>
  </div>`;
  
  // Results area
  html += '<div id="stressResults"></div>';
  
  el.innerHTML = html;
  
  // Setup custom type change handler
  const typeSelect = document.getElementById('stressType');
  const targetSelect = document.getElementById('stressTarget');
  if (typeSelect) {
    typeSelect.addEventListener('change', () => {
      const type = typeSelect.value;
      if (type === 'all') {
        targetSelect.style.display = 'none';
      } else {
        targetSelect.style.display = 'block';
        targetSelect.innerHTML = '';
        if (type === 'ticker') {
          const tickers = new Set();
          for (const acct of Object.values(s.accounts)) {
            for (const pos of acct.positions) tickers.add(pos.ticker);
          }
          [...tickers].sort().forEach(t => targetSelect.innerHTML += `<option value="${t}">${t}</option>`);
        } else if (type === 'currency') {
          ['CAD','USD','AUD','GBP'].forEach(c => targetSelect.innerHTML += `<option value="${c}">${c}</option>`);
        }
      }
    });
  }
  
  // Show results if scenario was already selected
  if (stressScenario !== null) {
    runStressTest(stressScenario);
  }
}

// Store scenarios globally for access
const STRESS_SCENARIOS = [
  { name: 'Gold -30%', type: 'sector', sector: 'Precious Metals', change: -30 },
  { name: 'Gold +50%', type: 'sector', sector: 'Precious Metals', change: 50 },
  { name: 'All -20%', type: 'all', change: -20 },
  { name: 'All -50%', type: 'all', change: -50 },
  { name: 'CAD -15%', type: 'currency', currency: 'CAD', change: -15 },
  { name: 'AUD -20%', type: 'currency', currency: 'AUD', change: -20 },
  { name: 'Tech -40%', type: 'sector', sector: 'Technology', change: -40 },
  { name: 'ETM -80%', type: 'ticker', ticker: 'ETM', change: -80 },
  { name: 'Market Crash -40%', type: 'all', change: -40 },
];

function calculateStressImpact(scenario) {
  if (!DATA) return null;
  const s = latest();
  let impactGbp = 0;
  
  const allPositions = [];
  for (const acct of Object.values(s.accounts)) {
    for (const pos of acct.positions) allPositions.push(pos);
  }
  
  const changeFactor = scenario.change / 100;
  
  for (const pos of allPositions) {
    let affected = false;
    
    if (scenario.type === 'all') {
      affected = true;
    } else if (scenario.type === 'sector') {
      const sec = (SECTORS[pos.ticker] || ['Other'])[0];
      affected = sec === scenario.sector;
    } else if (scenario.type === 'currency') {
      affected = pos.currency === scenario.currency;
    } else if (scenario.type === 'ticker') {
      affected = pos.ticker === scenario.ticker;
    }
    
    if (affected) {
      impactGbp += pos.value_gbp * changeFactor;
    }
  }
  
  return impactGbp;
}

function runStressTest(index) {
  stressScenario = index;
  const scenario = STRESS_SCENARIOS[index];
  
  // Update button states
  document.querySelectorAll('.stress-btn').forEach((btn, i) => {
    if (i < STRESS_SCENARIOS.length) {
      btn.className = i === index ? 'stress-btn active' : 'stress-btn';
    }
  });
  
  showStressResults(scenario);
}

function runCustomStress() {
  const type = document.getElementById('stressType').value;
  const target = document.getElementById('stressTarget')?.value;
  const change = parseFloat(document.getElementById('stressChange').value);
  
  if (isNaN(change)) return;
  
  const scenario = { name: 'Custom', type, change };
  if (type === 'ticker') scenario.ticker = target;
  if (type === 'currency') scenario.currency = target;
  
  stressScenario = -1; // custom
  document.querySelectorAll('.stress-btn').forEach(btn => btn.classList.remove('active'));
  
  showStressResults(scenario);
}

function showStressResults(scenario) {
  const resultsEl = document.getElementById('stressResults');
  if (!resultsEl || !DATA) return;
  
  const s = latest();
  const totalValue = s.family_total.total_gbp;
  const impactGbp = calculateStressImpact(scenario);
  const newValue = totalValue + impactGbp;
  const impactPct = (impactGbp / totalValue * 100);
  const isLoss = impactGbp < 0;
  
  // Recovery calculations (for losses only)
  const recoveryRates = [5, 10, 15, 20, 30];
  
  let html = `<div class="stress-result">
    <div style="display:flex;gap:20px;flex-wrap:wrap;align-items:center;margin-bottom:16px">
      <div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">${scenario.name} Scenario</div>
        <div class="stress-impact ${isLoss ? 'negative' : 'positive'}">${isLoss ? '' : '+'}${impactPct.toFixed(1)}%</div>
        <div style="font-size:14px;color:var(--text-muted);margin-top:4px">${isLoss ? '' : '+'}¬£${Math.abs(impactGbp).toLocaleString('en-GB',{maximumFractionDigits:0})}</div>
      </div>
      <div style="flex:1;min-width:200px">
        <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
          <span style="color:var(--text-muted)">Current Value</span>
          <span>¬£${totalValue.toLocaleString('en-GB',{maximumFractionDigits:0})}</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
          <span style="color:var(--text-muted)">Post-Stress Value</span>
          <span class="${isLoss ? 'negative' : 'positive'}" style="font-weight:700">¬£${newValue.toLocaleString('en-GB',{maximumFractionDigits:0})}</span>
        </div>
        <div style="height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;margin-top:8px">
          <div style="height:100%;width:${Math.max(0, (newValue/totalValue)*100)}%;background:${isLoss ? 'var(--red)' : 'var(--green)'};border-radius:3px;transition:width .3s"></div>
        </div>
      </div>
    </div>`;
  
  if (isLoss) {
    html += `<div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-muted)">Recovery Time at Different Annual Return Rates</div>
    <div class="recovery-grid">`;
    
    recoveryRates.forEach(rate => {
      // Years to recover: log(original/new) / log(1 + rate/100)
      const yearsToRecover = Math.log(totalValue / newValue) / Math.log(1 + rate / 100);
      const months = Math.ceil(yearsToRecover * 12);
      const timeStr = months >= 24 ? `${(months/12).toFixed(1)}y` : `${months}mo`;
      
      html += `<div class="recovery-card">
        <div class="rate">${rate}% p.a.</div>
        <div class="time">${timeStr}</div>
        <div class="label">to recover</div>
      </div>`;
    });
    
    html += '</div>';
  }
  
  html += '</div>';
  resultsEl.innerHTML = html;
}

// ‚îÄ‚îÄ Hook into main data load ‚îÄ‚îÄ
const _origOnDataLoaded = typeof onDataLoaded === 'function' ? onDataLoaded : null;

// Override to also load risk engine data after main data loads
const _origLoadData = loadData;

// Patch: load risk engine data after authentication and data load
(function patchRiskEngine() {
  // Wait for DATA to be available, then load risk engine
  const checkInterval = setInterval(() => {
    if (DATA) {
      clearInterval(checkInterval);
      loadRiskEngineData();
    }
  }, 500);
  // Safety: stop checking after 30s
  setTimeout(() => clearInterval(checkInterval), 30000);
})();

// ============================================================================
// PWA: Service Worker Registration
// ============================================================================

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then((registration) => {
        console.log('[PWA] Service Worker registered:', registration.scope);
        
        // Check for updates periodically
        setInterval(() => {
          registration.update();
        }, 60000); // Check every minute
        
        // Listen for updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New service worker available - show update notification
              console.log('[PWA] New version available - reload to update');
              if (confirm('New version available! Reload to update?')) {
                newWorker.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
              }
            }
          });
        });
      })
      .catch((error) => {
        console.log('[PWA] Service Worker registration failed:', error);
      });
  });
  
  // Handle controlled state change (new service worker activated)
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    window.location.reload();
  });
}

// PWA Install Prompt
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  console.log('[PWA] Install prompt available');
  
  // Show install button if desired (optional - can add UI later)
  // For now, user can install via browser menu
});

window.addEventListener('appinstalled', () => {
  console.log('[PWA] App installed successfully');
  deferredPrompt = null;
});

// loadData() is now called by checkAuthStatus() after authentication
</script>
</body>
</html>
